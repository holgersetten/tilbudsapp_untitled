<!DOCTYPE html>
<html lang="no" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Middagstilbud ‚Äì Modern</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32'><text y='24' font-size='24'>üç≥</text></svg>">
  <style>
    :root {
      --bg: #fdfefe;
      --bg-alt: #f4f7fa;
      --surface: #ffffff;
      --surface-alt: #f1f5f9;
      --border: #e2e8f0;
      --border-strong:#cbd5e1;
      --text: #1e293b;
      --text-soft:#64748b;
      --accent: #2563eb;
      --accent-rgb: 37 99 235;
      --accent-alt:#1d4ed8;
      --warn:#ea580c;
      --success:#15803d;
      --radius-sm: 4px;
      --radius: 8px;
      --radius-lg: 12px;
      --radius-xl: 16px;
      --radius-full: 9999px;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    }
    [data-theme="dark"] {
      --bg: #0f1419;
      --bg-alt: #151b23;
      --surface: #1a2332;
      --surface-alt: #232b3c;
      --border: #2d3748;
      --border-strong:#4a5568;
      --text: #e2e8f0;
      --text-soft:#94a3b8;
      --accent: #3b82f6;
      --accent-rgb: 59 130 246;
      --accent-alt:#2563eb;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      border: 0;
    }
    .app-shell {
      min-height: 100vh;
      display: grid;
      grid-template-columns: 280px 1fr;
    }
    .sidebar {
      background: var(--surface);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      position: sticky;
      top: 0;
      height: 100vh;
      overflow-y: auto;
    }
    .brand {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .brand h1 {
      font-size: 20px;
      font-weight: 700;
      color: var(--text);
    }
    nav.primary-nav {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .tab-btn {
      padding: 12px 16px;
      border: none;
      background: transparent;
      color: var(--text-soft);
      font-size: 14px;
      font-weight: 500;
      border-radius: var(--radius);
      cursor: pointer;
      text-align: left;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .tab-btn:hover {
      background: var(--surface-alt);
      color: var(--text);
    }
    .tab-btn.active {
      background: var(--accent);
      color: white;
    }
    .store-filter {
      padding: 20px;
      flex: 1;
    }
    .store-filter h3 {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .store-buttons {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .store-btn {
      padding: 10px 12px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text-soft);
      font-size: 13px;
      border-radius: var(--radius);
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: left;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
    }
    .store-btn:hover {
      background: var(--surface-alt);
      border-color: var(--border-strong);
      color: var(--text);
    }
    .store-btn.active {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }
    .store-btn img {
      width: 16px;
      height: 16px;
      border-radius: 2px;
    }
    main {
      background: var(--bg-alt);
      padding: 40px;
      overflow-y: auto;
    }
    .content {
      display: none;
    }
    .content.active {
      display: block;
    }
    .header-section {
      margin-bottom: 32px;
    }
    .header-section h2 {
      font-size: 28px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 8px;
    }
    .header-section p {
      color: var(--text-soft);
      font-size: 16px;
    }
    .search-section {
      background: var(--surface);
      padding: 24px;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      margin-bottom: 32px;
    }
    .search-form {
      display: flex;
      gap: 12px;
      align-items: flex-end;
    }
    .input-group {
      flex: 1;
    }
    .input-group label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: var(--text);
      margin-bottom: 6px;
    }
    .search-input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 16px;
      background: var(--bg);
      color: var(--text);
      transition: border-color 0.2s ease;
    }
    .search-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgb(var(--accent-rgb) / 0.1);
    }
    .btn {
      padding: 12px 20px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      font-size: 14px;
      font-weight: 500;
      border-radius: var(--radius);
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }
    .btn:hover {
      background: var(--surface-alt);
      border-color: var(--border-strong);
    }
    .btn-primary {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }
    .btn-primary:hover {
      background: var(--accent-alt);
      border-color: var(--accent-alt);
    }
    .search-results {
      margin-top: 24px;
    }
    .ingredient-section {
      margin-bottom: 32px;
    }
    .ingredient-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
    }
    .ingredient-header h3 {
      font-size: 20px;
      font-weight: 600;
      color: var(--text);
    }
    .count-badge {
      background: var(--surface-alt);
      padding: 4px 10px;
      border-radius: var(--radius-full);
      font-size: 12px;
      font-weight: 600;
      color: var(--text-soft);
    }
    .offers-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
    }
    .offers-grid.fixed-size {
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    }
    .offers-grid.fixed-size .offer-card {
      height: 200px;
      display: flex;
      flex-direction: column;
    }
    .offer-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 16px;
      transition: all 0.2s ease;
      display: flex;
      flex-direction: column;
      position: relative;
    }
    .offer-card:hover {
      border-color: var(--border-strong);
      box-shadow: var(--shadow);
    }
    .offer-image {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    .offer-store-logo {
      width: 32px;
      height: 32px;
      border-radius: var(--radius-sm);
    }
    .offer-content {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .offer-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 8px;
      line-height: 1.4;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }
    .offer-price {
      margin-bottom: 6px;
    }
    .offer-price-main {
      font-size: 18px;
      font-weight: 700;
      color: var(--accent);
    }
    .offer-quantity {
      font-size: 12px;
      color: var(--text-soft);
      background: var(--surface-alt);
      padding: 2px 6px;
      border-radius: var(--radius-sm);
      display: inline-block;
      width: fit-content;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 100%;
    }
    .empty {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-soft);
    }
    .empty h3 {
      font-size: 20px;
      margin-bottom: 8px;
      color: var(--text);
    }
    .loading {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-soft);
      font-size: 16px;
    }
    @media (max-width: 820px) {
      .app-shell {
        grid-template-columns: 1fr;
      }
      .sidebar {
        position: static;
        height: auto;
        flex-direction: row;
        flex-wrap: wrap;
        gap: 20px;
        border-right: none;
        border-bottom: 1px solid var(--border);
      }
      nav.primary-nav {
        flex-direction: row;
        flex-wrap: wrap;
      }
      .store-filter {
        order: 10;
        width: 100%;
      }
    }
    @media (max-width: 560px) {
      main {
        padding: 28px 18px 80px;
      }
      .btn-primary, .btn {
        flex: 1;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <a href="#content" class="sr-only">Hopp til innhold</a>
  <div class="app-shell">
    <aside class="sidebar">
      <div class="brand">
        <span style="font-size:28px;">üç≥</span>
        <h1>Middagstilbud</h1>
      </div>
      
      <nav class="primary-nav">
        <button class="tab-btn active" id="tab-middager" onclick="showTab('middager')">
          <span>üçΩÔ∏è</span> Middager
        </button>
        <button class="tab-btn" id="tab-tilbud" onclick="showTab('tilbud')">
          <span>üè∑Ô∏è</span> Tilbud
        </button>
        <button class="tab-btn" id="tab-handleliste" onclick="showTab('handleliste')">
          <span>üõí</span> Handleliste
        </button>
      </nav>
      
      <div class="store-filter">
        <h3>Butikker</h3>
        <div class="store-buttons">
          <button class="store-btn active" data-store="" onclick="filterStore(this)">
            <span>üè™</span> Alle butikker
          </button>
          <button class="store-btn" data-store="Bunnpris" onclick="filterStore(this)">
            <img src="/images/bunnpris_logo.png" alt="Bunnpris" /> Bunnpris
          </button>
          <button class="store-btn" data-store="Rema 1000" onclick="filterStore(this)">
            <img src="/images/rema_logo.png" alt="Rema 1000" /> Rema 1000
          </button>
          <button class="store-btn" data-store="Meny" onclick="filterStore(this)">
            <img src="/images/meny_logo.png" alt="Meny" /> Meny
          </button>
          <button class="store-btn" data-store="Kiwi" onclick="filterStore(this)">
            <img src="/images/kiwi_logo.png" alt="Kiwi" /> Kiwi
          </button>
          <button class="store-btn" data-store="Spar" onclick="filterStore(this)">
            <img src="/images/spar_logo_1.png" alt="Spar" /> Spar
          </button>
          <button class="store-btn" data-store="Coop Extra" onclick="filterStore(this)">
            <img src="/images/coop_extra_logo.png" alt="Coop Extra" /> Coop Extra
          </button>
          <button class="store-btn" data-store="Coop Mega" onclick="filterStore(this)">
            <img src="/images/coop_mega_logo.png" alt="Coop Mega" /> Coop Mega
          </button>
          <button class="store-btn" data-store="Coop Marked" onclick="filterStore(this)">
            <img src="/images/coop_marked_logo.png" alt="Coop Marked" /> Coop Marked
          </button>
          <button class="store-btn" data-store="Coop Prix" onclick="filterStore(this)">
            <img src="/images/coop_prix_logo.png" alt="Coop Prix" /> Coop Prix
          </button>
          <button class="store-btn" data-store="Obs" onclick="filterStore(this)">
            <img src="/images/coop_obs_logo.png" alt="Obs" /> Obs
          </button>
        </div>
      </div>
    </aside>

    <main>
      <div id="middager-content" class="content active">
        <div class="header-section">
          <h2>Finn middagsforslag</h2>
          <p>S√∏k etter ingredienser for √• f√• personlige middagsforslag basert p√• tilbud</p>
        </div>
        
        <div class="search-section">
          <div class="search-form">
            <div class="input-group">
              <label for="ingredients-input">Ingredienser</label>
              <input 
                type="text" 
                id="ingredients-input" 
                class="search-input" 
                placeholder="f.eks. kj√∏ttdeig, pasta, tomater"
                onkeypress="if(event.key==='Enter') searchMeals()"
              />
            </div>
            <button type="button" class="btn btn-primary" onclick="searchMeals()">
              <span>üîç</span> S√∏k middager
            </button>
          </div>
        </div>
        
        <div id="content"></div>
      </div>

      <div id="tilbud-content" class="content">
        <div class="header-section">
          <h2>Alle tilbud</h2>
          <p>Se alle tilbud fra alle butikker</p>
        </div>
        <div id="offers-content"></div>
      </div>

      <div id="handleliste-content" class="content">
        <div class="header-section">
          <h2>Handleliste</h2>
          <p>Din personlige handleliste</p>
        </div>
        <div class="empty">
          <h3>Handleliste kommer snart</h3>
          <p>Denne funksjonen er under utvikling.</p>
        </div>
      </div>
    </main>
  </div>

  <script>
    // Global state
    const state = {
      offersRaw: [],
      selectedStore: '',
      generalOffersLoaded: false,
      loadingOffers: false
    };

    // Tab switching
    function showTab(tabName) {
      console.log('üéØ showTab called:', tabName);
      
      // Update tab buttons
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(`tab-${tabName}`).classList.add('active');
      
      // Update content
      document.querySelectorAll('.content').forEach(content => content.classList.remove('active'));
      document.getElementById(`${tabName}-content`).classList.add('active');
      
      // Load offers when showing tilbud tab
      if (tabName === 'tilbud' && !state.generalOffersLoaded) {
        loadCurrentOffers();
      }
    }

    // Load offers from API
    async function loadCurrentOffers() {
      console.log('üîÑ loadCurrentOffers() called');
      
      try {
        state.loadingOffers = true;
        document.getElementById('offers-content').innerHTML = '<div class="loading">Laster tilbud...</div>';
        
        console.log('üåê Fetching /api/offers...');
        const response = await fetch('/api/offers');
        console.log('üì° Response status:', response.status, response.ok);
        
        const offers = await response.json();
        console.log('üì¶ Received offers:', offers.length, 'items');
        console.log('üîç First 3 offers:', offers.slice(0, 3));
        console.log('üîç Store names in first 10:', offers.slice(0, 10).map(o => o.store));
        
        // Store the offers
        state.offersRaw = offers;
        state.generalOffersLoaded = true;
        state.loadingOffers = false;
        
        console.log('‚úÖ Processed offers for rendering:', offers.length);
        console.log('üéØ state.offersRaw structure:', state.offersRaw);
        console.log('üè™ Stores in processed offers:', offers.slice(0, 10).map(o => o.store));
        
        renderOffers();
        
      } catch(e) {
        console.error('‚ùå Error loading offers:', e);
        state.loadingOffers = false;
        document.getElementById('offers-content').innerHTML = '<div class="empty"><h3>Feil ved lasting</h3><p>Kunne ikke hente tilbud n√•.</p></div>';
      }
    }

    // Render offers to DOM
    function renderOffers() {
      console.log('üé® renderOffers() called');
      console.log('üìä state.offersRaw:', state.offersRaw);
      console.log('üîç state.offersRaw type:', typeof state.offersRaw);
      console.log('üîç state.offersRaw length:', state.offersRaw?.length);
      
      const content = document.getElementById('offers-content');
      if (state.loadingOffers) { 
        content.innerHTML = '<div class="loading">S√∏ker etter tilbud...</div>'; 
        return; 
      }
      
      // Check if we have data
      if (!state.offersRaw || state.offersRaw.length === 0) { 
        console.log('‚ùå No offersRaw data');
        content.innerHTML = '<div class="empty"><h3>Ingen tilbud</h3><p>Pr√∏v andre ingredienser.</p></div>'; 
        return; 
      }

      let offersToRender = [];
      
      // Check if it's grouped data (array of objects with ingredient/offers) or simple array
      const isGroupedData = Array.isArray(state.offersRaw) && state.offersRaw.length > 0 && 
                           state.offersRaw[0].hasOwnProperty('ingredient') && state.offersRaw[0].hasOwnProperty('offers');
      
      console.log('üîç Is grouped data:', isGroupedData);
      
      if (isGroupedData) {
        // Handle grouped data structure (from /api/best-offers)
        console.log('üìÇ Processing grouped data structure');
        const grouped = {};
        state.offersRaw.forEach(group => { 
          if (group.ingredient && group.offers) {
            grouped[group.ingredient] = group.offers;
          }
        });
        console.log('üìÇ Grouped offers:', Object.keys(grouped));
        
        // Filter by selected store and collect all offers
        Object.keys(grouped).forEach(ing => {
          console.log(`üîç Processing ingredient "${ing}" with ${grouped[ing].length} offers`);
          console.log(`üîç Current selectedStore: "${state.selectedStore}"`);
          console.log(`üîç Sample stores in this group:`, [...new Set(grouped[ing].slice(0, 5).map(o => o.store))]);
          
          const filtered = grouped[ing].filter(o => {
            if (!state.selectedStore || state.selectedStore === '') {
              return true; // Show all if no store selected
            }
            const matches = o.store && o.store.toLowerCase().includes(state.selectedStore.toLowerCase());
            if (!matches) {
              console.log(`üö´ Filtered out: "${o.store}" (doesn't match "${state.selectedStore}")`);
            }
            return matches;
          });
          
          console.log(`üéØ Filtered ${ing}: ${grouped[ing].length} -> ${filtered.length} offers`);
          offersToRender.push(...filtered);
        });
      } else {
        // Handle simple array structure (from /api/offers)
        console.log('üìã Processing simple offers array');
        console.log('üîç Current selectedStore:', state.selectedStore);
        console.log('üîç Sample store names:', [...new Set(state.offersRaw.slice(0, 20).map(o => o.store))]);
        offersToRender = state.offersRaw.filter(o => {
          if (!state.selectedStore || state.selectedStore === '') {
            return true; // Show all if no store selected
          }
          const matches = o.store && o.store.toLowerCase().includes(state.selectedStore.toLowerCase());
          return matches;
        });
      }

      console.log('üéØ Final offers to render:', offersToRender.length);
      console.log('üè™ Stores in final offers:', [...new Set(offersToRender.map(o => o.store))]);
      
      if (offersToRender.length === 0) {
        content.innerHTML = '<div class="empty"><h3>Ingen tilbud</h3><p>Ingen tilbud funnet for valgt butikk.</p></div>';
        return;
      }
      
      // Render the offers
      let html = '<div class="search-results">';
      html += `<div class="ingredient-section"><div class="ingredient-header"><h3>Aktuelle tilbud</h3><span class="count-badge">${offersToRender.length} tilbud</span></div><div class="offers-grid fixed-size">`;
      
      offersToRender.forEach(offer => {
        const priceVal = (()=>{ 
          if (!offer.price && offer.price!==0) return 'N/A'; 
          const str = offer.price.toString(); 
          return /kr/i.test(str)? str.replace(/\s*kr\s*$/i,'') : str; 
        })();
        html += `<div class="offer-card" data-store="${offer.store || ''}" data-heading="${offer.title || ''}">
          <div class="offer-image">
            <img class="offer-store-logo" src="${getStoreLogo(offer.store)}" alt="${offer.store}" />
          </div>
          <div class="offer-content">
            <h4 class="offer-title">${offer.title || 'Ukjent produkt'}</h4>
            <div class="offer-price"><span class="offer-price-main">${priceVal} kr</span></div>
            ${offer.quantity ? `<div class="offer-quantity" title="${offer.quantity}">${offer.quantity}</div>` : ''}
          </div>
        </div>`;
      });
      
      html += '</div></div></div>';
      content.innerHTML = html;
      console.log('‚úÖ Rendered offers to DOM');
    }

    function getStoreLogo(storeName) {
      const logos = { 
        'Rema 1000':'/images/rema_logo.png',
        'Kiwi':'/images/kiwi_logo.png',
        'Meny':'/images/meny_logo.png',
        'Coop Extra':'/images/coop_extra_logo.png',
        'Coop Mega':'/images/coop_mega_logo.png',
        'Coop Marked':'/images/coop_marked_logo.png',
        'Coop Prix':'/images/coop_prix_logo.png',
        'Obs':'/images/coop_obs_logo.png',
        'Bunnpris':'/images/bunnpris_logo.png',
        'Spar':'/images/spar_logo_1.png'
      };
      return logos[storeName] || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="24" height="24"%3E%3Crect width="24" height="24" fill="%23e5e7eb"/%3E%3C/svg%3E';
    }

    function filterStore(btn) {
      console.log('üéØ filterStore called, store:', btn.dataset.store);
      state.selectedStore = btn.dataset.store || '';
      
      // Update active button styling
      document.querySelectorAll('.store-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      
      // Auto-switch to Tilbud tab
      document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
      document.getElementById('tab-tilbud').classList.add('active');
      document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
      document.getElementById('tilbud-content').classList.add('active');
      
      // Re-render offers for this store
      renderOffers();
    }

    // Search for meal suggestions
    async function searchMeals() {
      loadMealsPage();
    }

    function loadMealsPage() {
      const ingredientsInput = document.getElementById('ingredients-input');
      const ingredients = ingredientsInput.value.trim();
      if (!ingredients) return;
      
      history.pushState(null, null, `?tab=middager&ingredients=${encodeURIComponent(ingredients)}`);
      searchBestOffers(ingredients);
    }

    async function searchBestOffers(ingredients) {
      console.log('üîç searchBestOffers called with:', ingredients);
      
      try {
        state.loadingOffers = true;
        document.getElementById('content').innerHTML = '<div class="loading">S√∏ker etter beste tilbud...</div>';
        
        const response = await fetch(`/api/best-offers?ingredients=${encodeURIComponent(ingredients)}`);
        const data = await response.json();
        
        console.log('üì¶ Best offers response:', data);
        
        state.offersRaw = data;
        state.loadingOffers = false;
        
        renderBestOffers();
        
      } catch(e) {
        console.error('‚ùå Error searching best offers:', e);
        state.loadingOffers = false;
        document.getElementById('content').innerHTML = '<div class="empty"><h3>Feil ved s√∏k</h3><p>Kunne ikke hente tilbud n√•.</p></div>';
      }
    }

    function renderBestOffers() {
      const content = document.getElementById('content');
      if (state.loadingOffers) { 
        content.innerHTML = '<div class="loading">S√∏ker etter tilbud...</div>'; 
        return; 
      }
      
      if (!state.offersRaw || state.offersRaw.length === 0) { 
        content.innerHTML = '<div class="empty"><h3>Ingen tilbud funnet</h3><p>Pr√∏v andre ingredienser.</p></div>'; 
        return; 
      }

      let html = '<div class="search-results">';
      
      state.offersRaw.forEach(group => {
        if (!group.offers || group.offers.length === 0) return;
        
        html += `<div class="ingredient-section">
          <div class="ingredient-header">
            <h3>${group.ingredient}</h3>
            <span class="count-badge">${group.offers.length} tilbud</span>
          </div>
          <div class="offers-grid">`;
        
        group.offers.forEach(offer => {
          const priceVal = (()=>{ 
            if (!offer.price && offer.price!==0) return 'N/A'; 
            const str = offer.price.toString(); 
            return /kr/i.test(str)? str.replace(/\s*kr\s*$/i,'') : str; 
          })();
          html += `<div class="offer-card" data-store="${offer.store || ''}" data-heading="${offer.title || ''}">
            <div class="offer-image">
              <img class="offer-store-logo" src="${getStoreLogo(offer.store)}" alt="${offer.store}" />
            </div>
            <div class="offer-content">
              <h4 class="offer-title">${offer.title || 'Ukjent produkt'}</h4>
              <div class="offer-price"><span class="offer-price-main">${priceVal} kr</span></div>
              ${offer.quantity ? `<div class="offer-quantity" title="${offer.quantity}">${offer.quantity}</div>` : ''}
            </div>
          </div>`;
        });
        
        html += '</div></div>';
      });
      
      html += '</div>';
      content.innerHTML = html;
    }

    // Check if we need to show "Middager" tab on load
    const currentTab = new URLSearchParams(window.location.search).get('tab');
    if (currentTab === 'middager') {
      showTab('middager');
    }

    // Check if we need to auto-search on page load
    const urlParams = new URLSearchParams(window.location.search);
    const autoIngredients = urlParams.get('ingredients');
    if (autoIngredients) {
      document.getElementById('ingredients-input').value = autoIngredients;
      setTimeout(() => searchBestOffers(autoIngredients), 100);
    }
  </script>
</body>
</html>
