<!DOCTYPE html>
<html lang="no" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Middagstilbud ‚Äì Modern</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32'><text y='24' font-size='24'>üç≥</text></svg>">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #fdfefe;
      --bg-alt: #f4f7fa;
      --surface: #ffffff;
      --surface-alt: #f1f5f9;
      --border: #e2e8f0;
      --border-strong:#cbd5e1;
      --text: #1e293b;
      --text-soft:#64748b;
      --accent: #2563eb;
      --accent-rgb: 37 99 235;
      --accent-alt:#1d4ed8;
      --warn:#ea580c;
      --success:#15803d;
      --radius-sm: 4px;
      --radius: 8px;
      --radius-lg: 12px;
      --radius-xl: 16px;
      --radius-full: 9999px;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    }
    [data-theme="dark"] {
      --bg: #0f1419;
      --bg-alt: #151b23;
      --surface: #1a2332;
      --surface-alt: #232b3c;
      --border: #2d3748;
      --border-strong:#4a5568;
      --text: #e2e8f0;
      --text-soft:#94a3b8;
      --accent: #3b82f6;
      --accent-rgb: 59 130 246;
      --accent-alt:#2563eb;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    }
    body {
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      border: 0;
    }
    .app-shell {
      min-height: 100vh;
      display: grid;
      grid-template-columns: 280px 1fr;
    }
    .sidebar {
      background: var(--surface);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      position: sticky;
      top: 0;
      height: 100vh;
      overflow-y: auto;
    }
    .brand {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .brand h1 {
      font-size: 20px;
      font-weight: 700;
      color: var(--text);
    }
    nav.primary-nav {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .tab-btn {
      padding: 12px 16px;
      border: none;
      background: transparent;
      color: var(--text-soft);
      font-size: 14px;
      font-weight: 500;
      border-radius: var(--radius);
      cursor: pointer;
      text-align: left;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .tab-btn:hover {
      background: var(--surface-alt);
      color: var(--text);
    }
    .tab-btn.active {
      background: var(--accent);
      color: white;
    }
    .store-filter {
      padding: 20px;
      flex: 1;
    }
    .store-filter h3 {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .store-buttons {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }
    .store-btn {
      padding: 8px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text-soft);
      font-size: 13px;
      border-radius: var(--radius);
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-weight: 500;
      min-height: 56px;
      aspect-ratio: 1;
    }
    .store-btn:hover {
      background: var(--surface-alt);
      border-color: var(--border-strong);
      color: var(--text);
    }
    .store-btn.active {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }
    .store-btn img {
      width: 40px;
      height: 40px;
      border-radius: 2px;
      object-fit: contain;
      pointer-events: none;
    }
    main {
      background: var(--bg-alt);
      padding: 40px;
      overflow-y: auto;
    }
    .content {
      display: none;
    }
    .content.active {
      display: block;
    }
    .header-section {
      margin-bottom: 32px;
    }
    .header-section h2 {
      font-size: 28px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 8px;
    }
    .header-section p {
      color: var(--text-soft);
      font-size: 16px;
    }
    .search-section {
      background: var(--surface);
      padding: 24px;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      margin-bottom: 32px;
    }
    .search-form {
      display: flex;
      gap: 12px;
      align-items: flex-end;
    }
    .input-group {
      flex: 1;
    }
    .input-group label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: var(--text);
      margin-bottom: 6px;
    }
    .search-input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 16px;
      background: var(--bg);
      color: var(--text);
      transition: border-color 0.2s ease;
    }
    .search-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgb(var(--accent-rgb) / 0.1);
    }
    .btn {
      padding: 12px 20px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      font-size: 14px;
      font-weight: 500;
      border-radius: var(--radius);
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }
    .btn:hover {
      background: var(--surface-alt);
      border-color: var(--border-strong);
    }
    .btn-primary {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }
    .btn-primary:hover {
      background: var(--accent-alt);
      border-color: var(--accent-alt);
    }
    .search-results {
      margin-top: 24px;
    }
    .ingredient-section {
      margin-bottom: 32px;
    }
    .ingredient-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
      gap: 12px;
    }
    .ingredient-header h3 {
      font-size: 20px;
      font-weight: 600;
      color: var(--text);
    }
    .header-controls {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .filter-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .filter-select {
      padding: 6px 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--surface);
      color: var(--text);
      font-size: 14px;
      cursor: pointer;
      transition: border-color 0.2s ease;
    }
    .filter-select:focus {
      outline: none;
      border-color: var(--accent);
    }
    .count-badge {
      background: var(--surface-alt);
      padding: 4px 10px;
      border-radius: var(--radius-full);
      font-size: 12px;
      font-weight: 600;
      color: var(--text-soft);
    }

    /* Suggested meals styling */
    .suggested-meals-section {
      margin-top: 24px;
    }
    .suggested-header {
      text-align: center;
      margin-bottom: 24px;
    }
    .suggested-header h3 {
      font-size: 24px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 8px;
    }
    .suggested-header p {
      color: var(--text-soft);
      font-size: 16px;
    }
    .suggested-meals-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 24px;
    }
    .meal-suggestion {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }
    .meal-suggestion:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      border-color: var(--accent);
    }
    .meal-icon {
      font-size: 32px;
      margin-bottom: 12px;
      display: block;
    }
    .meal-suggestion h4 {
      font-size: 16px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 8px;
    }
    .meal-suggestion p {
      font-size: 13px;
      color: var(--text-soft);
      margin: 0;
    }

    /* Ingredient suggestions styling */
    .ingredient-suggestions-section {
      margin-top: 24px;
    }
    .ingredient-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 16px;
    }
    .ingredient-tag {
      background: var(--surface);
      border: 1px solid var(--border);
      padding: 8px 16px;
      border-radius: var(--radius-full);
      font-size: 14px;
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .ingredient-tag:hover {
      background: var(--accent);
      color: white;
      transform: translateY(-1px);
    }

    /* All meals section */
    .all-meals-section {
      margin-top: 24px;
    }

    /* Selected tags styling */
    .selected-tags-container {
      margin-top: 16px;
      padding: 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
    }
    .selected-tags-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
    }
    .clear-all-btn {
      background: none;
      border: none;
      color: var(--accent);
      font-size: 12px;
      cursor: pointer;
      text-decoration: underline;
    }
    .clear-all-btn:hover {
      color: var(--accent-alt);
    }
    .selected-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .tags-input-area {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      cursor: text;
    }
    .tags-input-area:focus-within {
      outline: 1px solid var(--accent);
      outline-offset: 2px;
      border-radius: var(--radius);
    }
    .tag-input-wrapper {
      display: inline-flex;
      align-items: center;
    }
    .tag-input {
      border: none;
      background: var(--accent);
      color: white;
      padding: 0;
      border-radius: var(--radius-full);
      font-size: 16px;
      font-weight: 400;
      outline: none;
      min-width: 30px;
      width: 30px;
      height: 30px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
    }
    .tag-input::placeholder {
      color: rgba(255, 255, 255, 0.8);
      opacity: 1;
    }
    .tag-input:focus {
      width: 120px;
      padding: 6px 12px;
      cursor: text;
      font-size: 13px;
      text-align: left;
    }
    .tag-input.typing {
      width: 120px;
      text-align: left;
      cursor: text;
    }
    .selected-tag {
      background: var(--accent);
      color: white;
      padding: 6px 12px;
      border-radius: var(--radius-full);
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .tag-remove {
      background: rgba(255, 255, 255, 0.3);
      border: none;
      color: white;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      cursor: pointer;
      font-size: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .tag-remove:hover {
      background: rgba(255, 255, 255, 0.5);
    }

    /* Search fallback and link buttons */
    .search-fallback {
      margin-top: 24px;
      padding: 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      text-align: center;
    }
    .search-fallback p {
      margin: 0;
      color: var(--text-soft);
    }
    .link-btn {
      background: none;
      border: none;
      color: var(--accent);
      text-decoration: underline;
      cursor: pointer;
      font-size: inherit;
    }
    .link-btn:hover {
      color: var(--accent-alt);
    }

    /* Matching meals section */
    .matching-meals-section {
      margin-top: 24px;
    }
    .offers-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
    }
    .offers-grid.fixed-size {
      grid-template-columns: repeat(3, 1fr);
    }
    .offers-grid.fixed-size .offer-card {
      height: 260px;
      display: flex;
      flex-direction: column;
    }
    .offer-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 16px;
      transition: all 0.2s ease;
      display: flex;
      flex-direction: column;
      position: relative;
    }
    .offer-card:hover {
      border-color: var(--border-strong);
      box-shadow: var(--shadow);
    }
    .offer-image {
      position: relative;
      height: 180px;
      margin-bottom: 12px;
      border-radius: var(--radius);
      overflow: hidden;
      background: var(--surface-alt);
    }
    .offer-product-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: var(--radius);
    }
    .offer-store-logo {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 48px;
      height: 48px;
      border-radius: var(--radius-sm);
      object-fit: contain;
      background: rgba(255, 255, 255, 0.95);
      padding: 6px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
      border: 1px solid rgba(0, 0, 0, 0.05);
    }
    .offer-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      position: relative;
    }
    .offer-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 8px;
      line-height: 1.4;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
    }
    .offer-price {
      margin-bottom: 6px;
    }
    .offer-price-main {
      font-size: 20px;
      font-weight: 800;
      color: var(--accent);
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }
    .offer-quantity {
      font-size: 12px;
      color: var(--text-soft);
      background: var(--surface-alt);
      padding: 2px 6px;
      border-radius: var(--radius-sm);
      display: inline-block;
      width: fit-content;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 100%;
    }
    .empty {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-soft);
    }
    .empty h3 {
      font-size: 20px;
      margin-bottom: 8px;
      color: var(--text);
    }
    .loading {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-soft);
      font-size: 16px;
    }
    @media (max-width: 820px) {
      .app-shell {
        grid-template-columns: 1fr;
      }
      .sidebar {
        position: static;
        height: auto;
        flex-direction: row;
        flex-wrap: wrap;
        gap: 20px;
        border-right: none;
        border-bottom: 1px solid var(--border);
      }
      nav.primary-nav {
        flex-direction: row;
        flex-wrap: wrap;
      }
      .store-filter {
        order: 10;
        width: 100%;
      }
    }
    @media (max-width: 560px) {
      main {
        padding: 28px 18px 80px;
      }
      .btn-primary, .btn {
        flex: 1;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <a href="#content" class="sr-only">Hopp til innhold</a>
  <div class="app-shell">
    <aside class="sidebar">
      <div class="brand">
        <span style="font-size:28px;">üç≥</span>
        <h1>Middagstilbud</h1>
      </div>
      
      <nav class="primary-nav">
        <button class="tab-btn active" id="tab-middager" onclick="showTab('middager')">
          <span>üçΩÔ∏è</span> Middager
        </button>
        <button class="tab-btn" id="tab-tilbud" onclick="showTab('tilbud')">
          <span>üè∑Ô∏è</span> Tilbud
        </button>
        <button class="tab-btn" id="tab-handleliste" onclick="showTab('handleliste')">
          <span>üõí</span> Handleliste
        </button>
      </nav>
      
      <div class="store-filter">
        <h3>Butikker</h3>
        <div class="store-buttons">
          <button class="store-btn active" data-store="" onclick="filterStore(this)">
            <span style="font-size: 24px;">üè™</span>
          </button>
          <button class="store-btn" data-store="Bunnpris" onclick="filterStore(this)">
            <img src="/images/bunnpris_logo.png" alt="Bunnpris" />
          </button>
          <button class="store-btn" data-store="Rema 1000" onclick="filterStore(this)">
            <img src="/images/rema_logo.png" alt="Rema 1000" />
          </button>
          <button class="store-btn" data-store="Meny" onclick="filterStore(this)">
            <img src="/images/meny_logo.png" alt="Meny" />
          </button>
          <button class="store-btn" data-store="Kiwi" onclick="filterStore(this)">
            <img src="/images/kiwi_logo.png" alt="Kiwi" />
          </button>
          <button class="store-btn" data-store="Spar" onclick="filterStore(this)">
            <img src="/images/spar_logo_1.png" alt="Spar" />
          </button>
          <button class="store-btn" data-store="Coop Extra" onclick="filterStore(this)">
            <img src="/images/coop_extra_logo.png" alt="Coop Extra" />
          </button>
          <button class="store-btn" data-store="Coop Mega" onclick="filterStore(this)">
            <img src="/images/coop_mega_logo.png" alt="Coop Mega" />
          </button>
          <button class="store-btn" data-store="Coop Marked" onclick="filterStore(this)">
            <img src="/images/coop_marked_logo.png" alt="Coop Marked" />
          </button>
          <button class="store-btn" data-store="Coop Prix" onclick="filterStore(this)">
            <img src="/images/coop_prix_logo.png" alt="Coop Prix" />
          </button>
          <button class="store-btn" data-store="Obs" onclick="filterStore(this)">
            <img src="/images/coop_obs_logo.png" alt="Obs" />
          </button>
          <button class="store-btn" data-store="Joker" onclick="filterStore(this)">
            <img src="/images/joker_logo.png" alt="Joker" />
          </button>
        </div>
      </div>
    </aside>

    <main>
      <div id="middager-content" class="content active">
        <div class="header-section">
          <h2>Finn middagsforslag</h2>
          <p>S√∏k etter ingredienser for √• f√• personlige middagsforslag basert p√• tilbud</p>
        </div>
        
        <div class="search-section">
          <div class="search-form">
            <div class="input-group">
              <label for="ingredients-input">S√∏k etter middager eller ingredienser</label>
              <input 
                type="text" 
                id="ingredients-input" 
                class="search-input" 
                placeholder="f.eks. pasta, curry, kj√∏ttdeig"
                onkeypress="if(event.key==='Enter') searchMeals()"
                oninput="handleSearchInput()"
              />
            </div>
            <button type="button" class="btn btn-primary" onclick="searchMeals()">
              <span>üîç</span> S√∏k middager
            </button>
          </div>
          
          <!-- Selected ingredient tags -->
          <div id="selected-tags" class="selected-tags-container" style="display: none;">
            <div class="selected-tags-header">
              <span>Valgte ingredienser:</span>
              <button class="clear-all-btn" onclick="clearAllTags()">Fjern alle</button>
            </div>
            <div class="tags-input-area" onclick="focusTagInput()">
              <div id="selected-tags-list" class="selected-tags"></div>
              <div class="tag-input-wrapper">
                <input 
                  type="text" 
                  id="tag-input" 
                  class="tag-input" 
                  placeholder="+"
                  onkeyup="handleTagInput(event)"
                  onblur="handleTagBlur()"
                  onfocus="handleTagFocus()"
                />
              </div>
            </div>
          </div>
        </div>
        
        <div id="content">
          <!-- Placeholder meal suggestions shown on page load -->
          <div id="placeholder-meals" class="suggested-meals-section">
            <div class="suggested-header">
              <h3>‚ú® Popul√¶re middagsforslag</h3>
              <p>Velg en av disse popul√¶re rettene eller s√∏k etter egne ingredienser</p>
            </div>
            <div class="suggested-meals-grid">
              <div class="meal-suggestion" onclick="loadMealSuggestion('spaghetti, kj√∏ttdeig, tomater')">
                <div class="meal-icon">üçù</div>
                <h4>Spaghetti Bolognese</h4>
                <p>spaghetti, kj√∏ttdeig, tomater</p>
              </div>
              <div class="meal-suggestion" onclick="loadMealSuggestion('kyllingfilet, kokosmelk, karri')">
                <div class="meal-icon">üçõ</div>
                <h4>Kylling i Curry</h4>
                <p>kyllingfilet, kokosmelk, karri</p>
              </div>
              <div class="meal-suggestion" onclick="loadMealSuggestion('kj√∏ttdeig, tacoskjell, tomat')">
                <div class="meal-icon">üåÆ</div>
                <h4>Taco med Kj√∏ttdeig</h4>
                <p>kj√∏ttdeig, tacoskjell, tomat</p>
              </div>
              <div class="meal-suggestion" onclick="loadMealSuggestion('laks, salat, avokado')">
                <div class="meal-icon">üêü</div>
                <h4>Laksesalat</h4>
                <p>laks, salat, avokado</p>
              </div>
              <div class="meal-suggestion" onclick="loadMealSuggestion('pasta, bacon, egg')">
                <div class="meal-icon">ÔøΩ</div>
                <h4>Pasta Carbonara</h4>
                <p>pasta, bacon, egg</p>
              </div>
              <div class="meal-suggestion" onclick="loadMealSuggestion('pizzabunn, mozzarella, tomatsaus')">
                <div class="meal-icon">ÔøΩ</div>
                <h4>Pizza Margherita</h4>
                <p>pizzabunn, mozzarella, tomatsaus</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="tilbud-content" class="content">
        <div class="header-section">
          <h2>Alle tilbud</h2>
          <p>Se alle tilbud fra alle butikker</p>
        </div>
        
        <div class="search-section">
          <div class="search-form">
            <div class="input-group">
              <label for="offers-search-input">S√∏k i tilbud</label>
              <input 
                type="text" 
                id="offers-search-input" 
                class="search-input" 
                placeholder="f.eks. kj√∏ttdeig, yogurt, br√∏d"
                onkeypress="if(event.key==='Enter') searchOffers()"
                oninput="handleOffersSearchInput()"
              />
            </div>
            <button type="button" class="btn btn-primary" onclick="searchOffers()">
              <span>üîç</span> S√∏k tilbud
            </button>
          </div>
        </div>
        
        <div id="offers-content"></div>
      </div>

      <div id="handleliste-content" class="content">
        <div class="header-section">
          <h2>Handleliste</h2>
          <p>Din personlige handleliste</p>
        </div>
        <div class="empty">
          <h3>Handleliste kommer snart</h3>
          <p>Denne funksjonen er under utvikling.</p>
        </div>
      </div>
    </main>
  </div>

  <script>
    // Global state
    const state = {
      offersRaw: [],
      selectedStore: '',
      generalOffersLoaded: false,
      loadingOffers: false,
      sortBy: '', // '', 'price', 'title', 'store'
      sortOrder: 'asc', // 'asc', 'desc'
      priceFilter: 'all', // 'all', 'under50', 'under100', 'over100'
      selectedTags: new Set(), // Track selected ingredient tags
      offersSearchTimeout: null // For debounced search
    };

    // Tab switching
    function showTab(tabName) {
      console.log('üéØ showTab called:', tabName);
      
      // Update tab buttons
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(`tab-${tabName}`).classList.add('active');
      
      // Update content
      document.querySelectorAll('.content').forEach(content => content.classList.remove('active'));
      document.getElementById(`${tabName}-content`).classList.add('active');
      
      // Load offers when showing tilbud tab
      if (tabName === 'tilbud') {
        if (!state.generalOffersLoaded) {
          loadCurrentOffers();
        } else {
          // If offers are already loaded, trigger search to show current results
          setTimeout(() => searchOffers(), 100);
        }
      }
      
      // Load all meal suggestions when showing middager tab
      if (tabName === 'middager') {
        const container = document.getElementById('selected-tags');
        const searchInput = document.getElementById('search-input');
        const hasSearchTerm = searchInput.value.trim().length > 0;
        const hasTags = state.selectedTags.size > 0;
        
        // Only show tag container if user has searched or has tags
        if (hasSearchTerm || hasTags) {
          container.style.display = 'block';
        } else {
          container.style.display = 'none';
        }
        
        const ingredientsInput = document.getElementById('ingredients-input');
        if (!ingredientsInput.value.trim() && state.selectedTags.size === 0 && !hasSearchTerm) {
          setTimeout(() => loadAllMealSuggestions(), 100);
        }
      }
    }

    // Search offers based on input
    async function searchOffers() {
      console.log('üîç searchOffers() called');
      
      try {
        const searchTerm = document.getElementById('offers-search-input').value.trim().toLowerCase();
        console.log('üîç Search term:', searchTerm);
        
        state.loadingOffers = true;
        document.getElementById('offers-content').innerHTML = '<div class="loading">S√∏ker i tilbud...</div>';
        
        // Load all offers if not already loaded
        if (!state.offersRaw || state.offersRaw.length === 0) {
          console.log('üì¶ Loading all offers first...');
          const response = await fetch('/api/offers');
          if (!response.ok) {
            throw new Error('Failed to load offers');
          }
          const offers = await response.json();
          state.offersRaw = offers;
        }
        
        let filteredOffers = [];
        
        if (!searchTerm) {
          // Show all offers if no search term
          filteredOffers = state.offersRaw;
        } else {
          // Filter offers based on search term
          filteredOffers = state.offersRaw.filter(offer => {
            const title = (offer.title || '').toLowerCase();
            const description = (offer.description || '').toLowerCase();
            const store = (offer.store || '').toLowerCase();
            return title.includes(searchTerm) || 
                   description.includes(searchTerm) || 
                   store.includes(searchTerm);
          });
        }
        
        console.log(`üéØ Found ${filteredOffers.length} offers matching "${searchTerm}"`);
        
        // Update state with filtered offers
        const originalOffers = state.offersRaw;
        state.offersRaw = filteredOffers;
        state.loadingOffers = false;
        
        // Render filtered offers
        renderOffers();
        
        // Restore original offers to state for future searches
        setTimeout(() => {
          if (originalOffers) {
            state.offersRaw = originalOffers;
          }
        }, 100);
        
      } catch (error) {
        console.error('‚ùå Error searching offers:', error);
        state.loadingOffers = false;
        document.getElementById('offers-content').innerHTML = `
          <div class="error">
            <h3>Kunne ikke s√∏ke i tilbud</h3>
            <p>Pr√∏v igjen senere</p>
          </div>
        `;
      }
    }
    
    // Handle offers search input
    function handleOffersSearchInput() {
      const searchInput = document.getElementById('offers-search-input');
      const searchTerm = searchInput.value.trim();
      
      // Auto-search after short delay for better UX
      if (state.offersSearchTimeout) {
        clearTimeout(state.offersSearchTimeout);
      }
      
      state.offersSearchTimeout = setTimeout(() => {
        if (searchTerm.length >= 2 || searchTerm.length === 0) {
          searchOffers();
        }
      }, 300);
    }

    // Load offers from API
    async function loadCurrentOffers() {
      console.log('üîÑ loadCurrentOffers() called');
      
      try {
        state.loadingOffers = true;
        document.getElementById('offers-content').innerHTML = '<div class="loading">Laster tilbud...</div>';
        
        console.log('üåê Fetching /api/offers...');
        const response = await fetch('/api/offers');
        console.log('üì° Response status:', response.status, response.ok);
        
        const offers = await response.json();
        console.log('üì¶ Received offers:', offers.length, 'items');
        console.log('üîç First 3 offers:', offers.slice(0, 3));
        console.log('üîç Store names in first 10:', offers.slice(0, 10).map(o => o.store));
        
        // Store the offers
        state.offersRaw = offers;
        state.generalOffersLoaded = true;
        state.loadingOffers = false;
        
        console.log('‚úÖ Processed offers for rendering:', offers.length);
        console.log('üéØ state.offersRaw structure:', state.offersRaw);
        console.log('üè™ Stores in processed offers:', offers.slice(0, 10).map(o => o.store));
        
        renderOffers();
        
      } catch(e) {
        console.error('‚ùå Error loading offers:', e);
        state.loadingOffers = false;
        document.getElementById('offers-content').innerHTML = '<div class="empty"><h3>Feil ved lasting</h3><p>Kunne ikke hente tilbud n√•.</p></div>';
      }
    }

    // Render offers to DOM
    function renderOffers() {
      console.log('üé® renderOffers() called');
      console.log('üìä state.offersRaw:', state.offersRaw);
      console.log('üîç state.offersRaw type:', typeof state.offersRaw);
      console.log('üîç state.offersRaw length:', state.offersRaw?.length);
      
      const content = document.getElementById('offers-content');
      if (state.loadingOffers) { 
        content.innerHTML = '<div class="loading">S√∏ker etter tilbud...</div>'; 
        return; 
      }
      
      // Check if we have data
      if (!state.offersRaw || state.offersRaw.length === 0) { 
        console.log('‚ùå No offersRaw data');
        content.innerHTML = '<div class="empty"><h3>Ingen tilbud</h3><p>Pr√∏v andre ingredienser.</p></div>'; 
        return; 
      }

      let offersToRender = [];
      
      // Check if it's grouped data (array of objects with ingredient/offers) or simple array
      const isGroupedData = Array.isArray(state.offersRaw) && state.offersRaw.length > 0 && 
                           state.offersRaw[0].hasOwnProperty('ingredient') && state.offersRaw[0].hasOwnProperty('offers');
      
      console.log('üîç Is grouped data:', isGroupedData);
      
      if (isGroupedData) {
        // Handle grouped data structure (from /api/best-offers)
        console.log('üìÇ Processing grouped data structure');
        const grouped = {};
        state.offersRaw.forEach(group => { 
          if (group.ingredient && group.offers) {
            grouped[group.ingredient] = group.offers;
          }
        });
        console.log('üìÇ Grouped offers:', Object.keys(grouped));
        
        // Filter by selected store and collect all offers
        Object.keys(grouped).forEach(ing => {
          console.log(`üîç Processing ingredient "${ing}" with ${grouped[ing].length} offers`);
          console.log(`üîç Current selectedStore: "${state.selectedStore}"`);
          console.log(`üîç Sample stores in this group:`, [...new Set(grouped[ing].slice(0, 5).map(o => o.store))]);
          
          const filtered = grouped[ing].filter(o => {
            if (!state.selectedStore || state.selectedStore === '') {
              return true; // Show all if no store selected
            }
            const matches = o.store && o.store.toLowerCase().includes(state.selectedStore.toLowerCase());
            if (!matches) {
              console.log(`üö´ Filtered out: "${o.store}" (doesn't match "${state.selectedStore}")`);
            }
            return matches;
          });
          
          console.log(`üéØ Filtered ${ing}: ${grouped[ing].length} -> ${filtered.length} offers`);
          offersToRender.push(...filtered);
        });
      } else {
        // Handle simple array structure (from /api/offers)
        console.log('üìã Processing simple offers array');
        console.log('üîç Current selectedStore:', state.selectedStore);
        console.log('üîç Sample store names:', [...new Set(state.offersRaw.slice(0, 20).map(o => o.store))]);
        offersToRender = state.offersRaw.filter(o => {
          if (!state.selectedStore || state.selectedStore === '') {
            return true; // Show all if no store selected
          }
          const matches = o.store && o.store.toLowerCase().includes(state.selectedStore.toLowerCase());
          return matches;
        });
      }

      console.log('üéØ Final offers to render:', offersToRender.length);
      console.log('üè™ Stores in final offers:', [...new Set(offersToRender.map(o => o.store))]);
      
      if (offersToRender.length === 0) {
        content.innerHTML = '<div class="empty"><h3>Ingen tilbud</h3><p>Ingen tilbud funnet for valgt butikk.</p></div>';
        return;
      }
      
      // Apply price filter and sorting
      offersToRender = filterOffersByPrice(offersToRender);
      offersToRender = sortOffers(offersToRender);
      
      // Render the offers
      let html = '<div class="search-results">';
      html += `<div class="ingredient-section">
        <div class="ingredient-header">
          <h3>Aktuelle tilbud</h3>
          <div class="header-controls">
            <div class="filter-controls">
              <select class="filter-select" onchange="updateSort(this.value)">
                <option value="" ${state.sortBy === '' ? 'selected' : ''}>Ingen sortering</option>
                <option value="price" ${state.sortBy === 'price' ? 'selected' : ''}>Pris ${state.sortBy === 'price' ? (state.sortOrder === 'asc' ? '‚Üë' : '‚Üì') : ''}</option>
                <option value="title" ${state.sortBy === 'title' ? 'selected' : ''}>Navn ${state.sortBy === 'title' ? (state.sortOrder === 'asc' ? '‚Üë' : '‚Üì') : ''}</option>
                <option value="store" ${state.sortBy === 'store' ? 'selected' : ''}>Butikk ${state.sortBy === 'store' ? (state.sortOrder === 'asc' ? '‚Üë' : '‚Üì') : ''}</option>
              </select>
              <select class="filter-select" onchange="updatePriceFilter(this.value)">
                <option value="all" ${state.priceFilter === 'all' ? 'selected' : ''}>Alle priser</option>
                <option value="under50" ${state.priceFilter === 'under50' ? 'selected' : ''}>Under 50kr</option>
                <option value="under100" ${state.priceFilter === 'under100' ? 'selected' : ''}>Under 100kr</option>
                <option value="over100" ${state.priceFilter === 'over100' ? 'selected' : ''}>Over 100kr</option>
              </select>
            </div>
            <span class="count-badge">${offersToRender.length} tilbud</span>
          </div>
        </div>
        <div class="offers-grid fixed-size">`;
      
      offersToRender.forEach(offer => {
        const priceVal = (()=>{ 
          if (!offer.price && offer.price!==0) return 'N/A'; 
          const str = offer.price.toString(); 
          return /kr/i.test(str)? str.replace(/\s*kr\s*$/i,'') : str; 
        })();
        html += `<div class="offer-card" data-store="${offer.store || ''}" data-heading="${offer.title || ''}">
          <div class="offer-image">
            <img class="offer-product-image" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100'%3E%3Crect width='100' height='100' fill='%23f3f4f6'/%3E%3Ctext x='50' y='50' text-anchor='middle' dy='.3em' fill='%23999'%3Elaster bilde%3C/text%3E%3C/svg%3E" alt="Produktbilde" style="display:none;" />
            <img class="offer-store-logo" src="${getStoreLogo(offer.store)}" alt="${offer.store}" />
          </div>
          <div class="offer-content">
            <h4 class="offer-title">${formatTitle(offer.title)}</h4>
            <div class="offer-price"><span class="offer-price-main">${priceVal} kr</span></div>
            ${offer.quantity ? `<div class="offer-quantity" title="${offer.quantity}">${offer.quantity}</div>` : ''}
          </div>
        </div>`;
      });
      
      html += '</div></div></div>';
      content.innerHTML = html;
      console.log('‚úÖ Rendered offers to DOM');
      
      // Load product images
      setTimeout(() => loadProductImages(), 100);
    }

    function getStoreLogo(storeName) {
      const logos = { 
        'Rema 1000': '/images/rema_logo.png',
        'Kiwi': '/images/kiwi_logo.png',
        'Meny': '/images/meny_logo.png',
        'Coop Extra': '/images/coop_extra_logo.png',
        'Coop Mega': '/images/coop_mega_logo.png',
        'Coop Marked': '/images/coop_marked_logo.png',
        'Coop Prix': '/images/coop_prix_logo.png',
        'Obs': '/images/coop_obs_logo.png',
        'Bunnpris': '/images/bunnpris_logo.png',
        'Spar': '/images/spar_logo_1.png',
        'Joker': '/images/joker_logo.png'
      };
      return logos[storeName] || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="32" height="32"%3E%3Ctext y="24" font-size="20" text-anchor="middle" x="16"%3Eüè™%3C/text%3E%3C/svg%3E';
    }

    function formatTitle(title) {
      if (!title) return 'Ukjent produkt';
      
      // Convert to lowercase first, then capitalize each word
      return title.toLowerCase()
        .split(' ')
        .map(word => {
          // Handle special cases like "kg", "ml", "l", etc.
          if (['kg', 'g', 'ml', 'l', 'dl', 'cl', 'stk', 'pk', 'bx', 'fl'].includes(word)) {
            return word;
          }
          // Handle numbers with units like "500g", "1l"
          if (/^\d+[a-z]+$/.test(word)) {
            return word;
          }
          // Capitalize first letter of regular words
          return word.charAt(0).toUpperCase() + word.slice(1);
        })
        .join(' ');
    }

    async function loadProductImages() {
      console.log('üñºÔ∏è Starting loadProductImages function');
      
      const offerCards = document.querySelectorAll('.offer-card[data-store][data-heading]');
      console.log(`üñºÔ∏è Found ${offerCards.length} offer cards with data attributes`);
      
      for (const card of offerCards) {
        const storeName = card.getAttribute('data-store');
        const heading = card.getAttribute('data-heading');
        const imageElement = card.querySelector('.offer-product-image');
        
        console.log(`üñºÔ∏è Processing card: store="${storeName}", heading="${heading}"`);
        
        if (!imageElement) {
          console.log('üñºÔ∏è No image element found in card');
          continue;
        }
        
        try {
          const url = `/api/product-image/${encodeURIComponent(storeName)}/${encodeURIComponent(heading)}`;
          console.log(`üñºÔ∏è Fetching image from: ${url}`);
          
          const response = await fetch(url);
          if (!response.ok) {
            console.log(`üñºÔ∏è Failed to fetch image: ${response.status} ${response.statusText}`);
            continue;
          }
          
          const data = await response.json();
          console.log(`üñºÔ∏è Received image data:`, data);
          
          if (data.imageUrl) {
            imageElement.src = data.imageUrl;
            imageElement.style.display = 'block';
            console.log(`üñºÔ∏è Set image URL: ${data.imageUrl}`);
          } else {
            console.log('üñºÔ∏è No imageUrl in response');
          }
        } catch (error) {
          console.error(`üñºÔ∏è Error loading image for ${storeName}/${heading}:`, error);
        }
      }
    }

    function sortOffers(offers) {
      if (!state.sortBy) return offers; // No sorting if none selected
      
      return offers.sort((a, b) => {
        switch (state.sortBy) {
          case 'price':
            const priceA = parseFloat(a.price?.toString().replace(/[^0-9.]/g, '') || '0');
            const priceB = parseFloat(b.price?.toString().replace(/[^0-9.]/g, '') || '0');
            return state.sortOrder === 'asc' ? priceA - priceB : priceB - priceA;
          case 'title':
            const titleA = (a.title || '').toLowerCase();
            const titleB = (b.title || '').toLowerCase();
            return state.sortOrder === 'asc' ? titleA.localeCompare(titleB) : titleB.localeCompare(titleA);
          case 'store':
            const storeA = (a.store || '').toLowerCase();
            const storeB = (b.store || '').toLowerCase();
            return state.sortOrder === 'asc' ? storeA.localeCompare(storeB) : storeB.localeCompare(storeA);
          default:
            return 0;
        }
      });
    }

    function filterOffersByPrice(offers) {
      if (state.priceFilter === 'all') return offers;
      
      return offers.filter(offer => {
        const price = parseFloat(offer.price?.toString().replace(/[^0-9.]/g, '') || '0');
        switch (state.priceFilter) {
          case 'under50': return price <= 50;
          case 'under100': return price <= 100;
          case 'over100': return price > 100;
          default: return true;
        }
      });
    }

    function updateSort(sortBy) {
      if (sortBy === '') {
        state.sortBy = '';
        state.sortOrder = 'asc';
      } else if (state.sortBy === sortBy) {
        state.sortOrder = state.sortOrder === 'asc' ? 'desc' : 'asc';
      } else {
        state.sortBy = sortBy;
        state.sortOrder = 'asc';
      }
      renderOffers();
    }

    function updatePriceFilter(filter) {
      state.priceFilter = filter;
      renderOffers();
    }

    function filterStore(btn) {
      console.log('üéØ filterStore called, store:', btn.dataset.store);
      state.selectedStore = btn.dataset.store || '';
      
      // Update active button styling
      document.querySelectorAll('.store-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      
      // Auto-switch to Tilbud tab
      document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
      document.getElementById('tab-tilbud').classList.add('active');
      document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
      document.getElementById('tilbud-content').classList.add('active');
      
      // Load offers if not already loaded
      if (!state.generalOffersLoaded) {
        loadCurrentOffers();
      } else {
        // Re-render offers for this store
        renderOffers();
      }
    }

    // Search for meal suggestions
    // Reset search state helper function
    function resetSearchState() {
      console.log('üîÑ Resetting search state');
      
      // Clear content areas
      const content = document.getElementById('content');
      const offersContent = document.getElementById('offers-content');
      const resultsContent = document.getElementById('results-content');
      
      if (content) content.innerHTML = '';
      if (offersContent) offersContent.innerHTML = '';
      if (resultsContent) resultsContent.innerHTML = '';
      
      // Reset offers state
      state.offersRaw = [];
      state.generalOffersLoaded = false;
      state.loadingOffers = false;
      
      // Show placeholder meals again
      const placeholderMeals = document.getElementById('placeholder-meals');
      if (placeholderMeals) {
        placeholderMeals.style.display = 'block';
      }
    }

    async function searchMeals() {
      const ingredientsInput = document.getElementById('ingredients-input');
      const searchTerm = ingredientsInput.value.trim();
      
      // Reset previous search state when starting new search
      if (searchTerm) {
        console.log('üîÑ Starting new meal search, resetting state');
        resetSearchState();
      }
      
      if (!searchTerm && state.selectedTags.size === 0) {
        loadAllMealSuggestions();
        return;
      }
      
      // If we have tags, prioritize searching for offers directly
      if (state.selectedTags.size > 0) {
        const ingredients = Array.from(state.selectedTags).join(', ');
        searchBestOffers(ingredients);
        return;
      }
      
      // Otherwise search in meal names first
      if (searchTerm) {
        await searchInMealNames(searchTerm);
      }
    }

    async function searchInMealNames(searchTerm) {
      try {
        // Show tag container since user is performing a search
        const container = document.getElementById('selected-tags');
        container.style.display = 'block';
        updateSelectedTagsDisplay();
        
        const response = await fetch(`/api/meals?search=${encodeURIComponent(searchTerm)}`);
        const meals = await response.json();
        
        if (meals.length > 0) {
          // Show matching meals
          renderMatchingMeals(meals, searchTerm);
        } else {
          // No meals found, search in ingredients
          await searchInIngredients(searchTerm);
        }
      } catch (error) {
        console.error('Error searching meals:', error);
        await searchInIngredients(searchTerm);
      }
    }

    function renderMatchingMeals(meals, searchTerm) {
      const content = document.getElementById('content');
      const placeholderMeals = document.getElementById('placeholder-meals');
      
      if (placeholderMeals) {
        placeholderMeals.style.display = 'none';
      }
      
      let html = '<div class="matching-meals-section">';
      html += '<div class="suggested-header">';
      html += `<h3>üçΩÔ∏è Middager som matcher "${searchTerm}"</h3>`;
      html += '<p>Klikk p√• en rett for √• s√∏ke etter tilbud p√• ingrediensene</p>';
      html += '</div>';
      html += '<div class="suggested-meals-grid">';
      
      meals.forEach(meal => {
        const ingredients = meal.ingredients.join(', ').toLowerCase();
        const icon = getMealIcon(meal.name);
        html += `
          <div class="meal-suggestion" onclick="loadMealSuggestion('${ingredients}')">
            <div class="meal-icon">${icon}</div>
            <h4>${meal.name}</h4>
            <p>${ingredients}</p>
          </div>`;
      });
      
      html += '</div>';
      
      // Add fallback to ingredient search
      html += '<div class="search-fallback">';
      html += `<p>Fant ikke det du lette etter? <button class="link-btn" onclick="searchInIngredients('${searchTerm}')">S√∏k i ingredienser i stedet</button></p>`;
      html += '</div>';
      
      html += '</div>';
      content.innerHTML = html;
    }

    async function searchInIngredients(searchTerm) {
      // Show ingredient suggestions based on search term
      const suggestions = [
        'kj√∏ttdeig', 'kyllingfilet', 'laks', 'pasta', 'ris', 'poteter',
        'tomat', 'l√∏k', 'gulr√∏tter', 'brokkoli', 'ost', 'egg',
        'bacon', 'fl√∏te', 'kokosmelk', 'karri', 'hvitl√∏k'
      ];
      
      // Filter suggestions based on search term
      const filteredSuggestions = suggestions.filter(ingredient => 
        ingredient.toLowerCase().includes(searchTerm.toLowerCase())
      );
      
      if (filteredSuggestions.length > 0) {
        renderFilteredIngredientSuggestions(filteredSuggestions, searchTerm);
      } else {
        renderIngredientSuggestions();
      }
    }

    function renderFilteredIngredientSuggestions(suggestions, searchTerm) {
      const content = document.getElementById('content');
      const placeholderMeals = document.getElementById('placeholder-meals');
      
      if (placeholderMeals) {
        placeholderMeals.style.display = 'none';
      }
      
      let html = '<div class="ingredient-suggestions-section">';
      html += '<div class="suggested-header">';
      html += `<h3>üí° Ingredienser som matcher "${searchTerm}"</h3>`;
      html += '<p>Klikk p√• en ingrediens for √• legge den til i s√∏ket</p>';
      html += '</div>';
      html += '<div class="ingredient-tags">';
      
      suggestions.forEach(ingredient => {
        html += `<span class="ingredient-tag" onclick="addIngredientTag('${ingredient}')">${ingredient}</span>`;
      });
      
      html += '</div></div>';
      content.innerHTML = html;
    }

    function handleSearchInput() {
      const ingredientsInput = document.getElementById('ingredients-input');
      const searchTerm = ingredientsInput.value.trim();
      
      // Show tag container when user starts searching, hide when clearing search
      const activeTab = document.querySelector('.tab-btn.active');
      if (activeTab && activeTab.id === 'tab-middager') {
        const container = document.getElementById('selected-tags');
        if (searchTerm.length > 0 || state.selectedTags.size > 0) {
          container.style.display = 'block';
        } else {
          container.style.display = 'none';
          // If search is cleared and no tags, show all meal suggestions
          setTimeout(() => loadAllMealSuggestions(), 100);
        }
        updateSelectedTagsDisplay();
      }
    }

    // Tag management functions
    function addIngredientTag(ingredient) {
      state.selectedTags.add(ingredient.toLowerCase().trim());
      updateSelectedTagsDisplay();
      
      // Automatically search when tag is added
      const ingredients = Array.from(state.selectedTags).join(', ');
      searchBestOffers(ingredients);
    }

    function handleTagInput(event) {
      const input = event.target;
      
      // Add typing class when user starts typing
      if (input.value.length > 0) {
        input.classList.add('typing');
      } else {
        input.classList.remove('typing');
      }
      
      if (event.key === 'Enter') {
        event.preventDefault();
        addTagFromInput();
      }
    }

    function handleTagFocus() {
      const input = document.getElementById('tag-input');
      if (input.value === '') {
        input.placeholder = '';
      }
    }

    function handleTagBlur() {
      const input = document.getElementById('tag-input');
      if (input.value.trim()) {
        addTagFromInput();
      } else {
        // Reset to plus sign when no input
        input.placeholder = '+';
        input.classList.remove('typing');
      }
    }

    function addTagFromInput() {
      const tagInput = document.getElementById('tag-input');
      const ingredient = tagInput.value.trim();
      
      if (ingredient && ingredient.length > 0) {
        addIngredientTag(ingredient);
        tagInput.value = '';
        tagInput.placeholder = '+';
        tagInput.classList.remove('typing');
        tagInput.blur(); // Remove focus to contract the input
      }
    }

    function focusTagInput(event) {
      // Prevent focusing if clicked on a tag or remove button
      if (event && (event.target.classList.contains('selected-tag') || 
                   event.target.classList.contains('tag-remove'))) {
        return;
      }
      
      const tagInput = document.getElementById('tag-input');
      tagInput.focus();
    }

    function removeIngredientTag(ingredient) {
      state.selectedTags.delete(ingredient);
      updateSelectedTagsDisplay();
      
      // Auto-focus the tag input after removing a tag with longer delay
      setTimeout(() => {
        const tagInput = document.getElementById('tag-input');
        if (tagInput) {
          tagInput.focus();
        }
      }, 150);
      
      if (state.selectedTags.size === 0) {
        const ingredientsInput = document.getElementById('ingredients-input');
        if (!ingredientsInput.value.trim()) {
          loadAllMealSuggestions();
        }
      } else {
        const ingredients = Array.from(state.selectedTags).join(', ');
        searchBestOffers(ingredients);
      }
    }

    function clearAllTags() {
      state.selectedTags.clear();
      resetSearchState(); // Clear all previous results
      updateSelectedTagsDisplay();
      
      const ingredientsInput = document.getElementById('ingredients-input');
      if (!ingredientsInput.value.trim()) {
        loadAllMealSuggestions();
      }
    }

    function updateSelectedTagsDisplay() {
      const container = document.getElementById('selected-tags');
      const tagsList = document.getElementById('selected-tags-list');
      
      // Always show the container if there are tags OR to allow adding new ones
      container.style.display = 'block';
      
      let html = '';
      state.selectedTags.forEach(tag => {
        html += `
          <div class="selected-tag">
            <span>${tag}</span>
            <button class="tag-remove" onclick="removeIngredientTag('${tag}')">√ó</button>
          </div>`;
      });
      
      tagsList.innerHTML = html;
      
      // Hide container only if no tags and user hasn't interacted with meals tab
      if (state.selectedTags.size === 0) {
        const ingredientsInput = document.getElementById('ingredients-input');
        if (!ingredientsInput.value.trim()) {
          // Only hide if we're not actively in meals mode
          const activeTab = document.querySelector('.tab-btn.active');
          if (!activeTab || activeTab.id !== 'tab-middager') {
            container.style.display = 'none';
          }
        }
      }
    }

    function loadMealSuggestion(ingredients) {
      // Clear text input and add ingredients as tags
      const ingredientsInput = document.getElementById('ingredients-input');
      ingredientsInput.value = '';
      
      // Parse ingredients and add as tags
      const ingredientList = ingredients.split(',').map(i => i.trim().toLowerCase());
      state.selectedTags.clear();
      ingredientList.forEach(ingredient => {
        if (ingredient) {
          state.selectedTags.add(ingredient);
        }
      });
      
      updateSelectedTagsDisplay();
      
      // Search for offers
      const ingredientsString = Array.from(state.selectedTags).join(', ');
      searchBestOffers(ingredientsString);
    }

    async function loadAllMealSuggestions() {
      try {
        const response = await fetch('/api/meals');
        const meals = await response.json();
        renderAllMealSuggestions(meals);
      } catch (error) {
        console.error('Error loading meal suggestions:', error);
        renderPlaceholderMeals();
      }
    }

    function renderAllMealSuggestions(meals) {
      const content = document.getElementById('content');
      const placeholderMeals = document.getElementById('placeholder-meals');
      
      if (placeholderMeals) {
        placeholderMeals.style.display = 'none';
      }
      
      let html = '<div class="all-meals-section">';
      html += '<div class="suggested-header">';
      html += '<h3>üçΩÔ∏è Alle middagsforslag</h3>';
      html += '<p>Klikk p√• en rett for √• s√∏ke etter tilbud p√• ingrediensene</p>';
      html += '</div>';
      html += '<div class="suggested-meals-grid">';
      
      meals.forEach(meal => {
        if (meal.category === 'middag') {
          const ingredients = meal.ingredients.join(', ').toLowerCase();
          const icon = getMealIcon(meal.name);
          html += `
            <div class="meal-suggestion" onclick="loadMealSuggestion('${ingredients}')">
              <div class="meal-icon">${icon}</div>
              <h4>${meal.name}</h4>
              <p>${ingredients}</p>
            </div>`;
        }
      });
      
      html += '</div></div>';
      content.innerHTML = html;
    }

    function getMealIcon(mealName) {
      const name = mealName.toLowerCase();
      if (name.includes('spaghetti') || name.includes('pasta')) return 'üçù';
      if (name.includes('curry') || name.includes('karri')) return 'üçõ';
      if (name.includes('taco')) return 'üåÆ';
      if (name.includes('laks') || name.includes('fisk')) return 'üêü';
      if (name.includes('pizza')) return 'üçï';
      if (name.includes('suppe')) return 'üç≤';
      if (name.includes('kylling')) return 'üçó';
      if (name.includes('biff')) return 'ü•©';
      return 'üçΩÔ∏è';
    }

    function renderIngredientSuggestions() {
      const content = document.getElementById('content');
      const placeholderMeals = document.getElementById('placeholder-meals');
      
      if (placeholderMeals) {
        placeholderMeals.style.display = 'none';
      }
      
      const suggestions = [
        'kj√∏ttdeig', 'kyllingfilet', 'laks', 'pasta', 'ris', 'poteter',
        'tomat', 'l√∏k', 'gulr√∏tter', 'brokkoli', 'ost', 'egg',
        'bacon', 'fl√∏te', 'kokosmelk', 'karri', 'hvitl√∏k'
      ];
      
      let html = '<div class="ingredient-suggestions-section">';
      html += '<div class="suggested-header">';
      html += '<h3>üí° Pr√∏v disse ingrediensene</h3>';
      html += '<p>Klikk p√• en ingrediens for √• legge den til i s√∏ket</p>';
      html += '</div>';
      html += '<div class="ingredient-tags">';
      
      suggestions.forEach(ingredient => {
        html += `<span class="ingredient-tag" onclick="addIngredientTag('${ingredient}')">${ingredient}</span>`;
      });
      
      html += '</div></div>';
      content.innerHTML = html;
    }

    async function searchBestOffers(ingredients) {
      console.log('üîç searchBestOffers called with:', ingredients);
      
      try {
        state.loadingOffers = true;
        document.getElementById('content').innerHTML = '<div class="loading">S√∏ker etter beste tilbud...</div>';
        
        const response = await fetch(`/api/best-offers?ingredients=${encodeURIComponent(ingredients)}`);
        const data = await response.json();
        
        console.log('üì¶ Best offers response:', data);
        
        state.offersRaw = data;
        state.loadingOffers = false;
        
        renderBestOffers();
        
      } catch(e) {
        console.error('‚ùå Error searching best offers:', e);
        state.loadingOffers = false;
        document.getElementById('content').innerHTML = '<div class="empty"><h3>Feil ved s√∏k</h3><p>Kunne ikke hente tilbud n√•.</p></div>';
      }
    }

    function renderBestOffers() {
      const content = document.getElementById('content');
      const placeholderMeals = document.getElementById('placeholder-meals');
      
      if (state.loadingOffers) { 
        content.innerHTML = '<div class="loading">S√∏ker etter tilbud...</div>'; 
        return; 
      }
      
      if (!state.offersRaw || state.offersRaw.length === 0) { 
        // Show ingredient suggestions instead of placeholder meals when no matches
        renderIngredientSuggestions();
        return; 
      }

      let html = '<div class="search-results">';
      
      state.offersRaw.forEach(group => {
        if (!group.offers || group.offers.length === 0) return;
        
        html += `<div class="ingredient-section">
          <div class="ingredient-header">
            <h3>${group.ingredient}</h3>
            <span class="count-badge">${group.offers.length} tilbud</span>
          </div>
          <div class="offers-grid">`;
        
        group.offers.forEach(offer => {
          const priceVal = (()=>{ 
            if (!offer.price && offer.price!==0) return 'N/A'; 
            const str = offer.price.toString(); 
            return /kr/i.test(str)? str.replace(/\s*kr\s*$/i,'') : str; 
          })();
          html += `<div class="offer-card" data-store="${offer.store || ''}" data-heading="${offer.title || ''}">
            <div class="offer-image">
              <img class="offer-product-image" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100'%3E%3Crect width='100' height='100' fill='%23f3f4f6'/%3E%3Ctext x='50' y='50' text-anchor='middle' dy='.3em' fill='%23999'%3Elaster bilde%3C/text%3E%3C/svg%3E" alt="Produktbilde" style="display:none;" />
              <img class="offer-store-logo" src="${getStoreLogo(offer.store)}" alt="${offer.store}" />
            </div>
            <div class="offer-content">
              <h4 class="offer-title">${formatTitle(offer.title)}</h4>
              <div class="offer-price"><span class="offer-price-main">${priceVal} kr</span></div>
              ${offer.quantity ? `<div class="offer-quantity" title="${offer.quantity}">${offer.quantity}</div>` : ''}
            </div>
          </div>`;
        });
        
        html += '</div></div>';
      });
      
      html += '</div>';
      content.innerHTML = html;
      
      // Load product images
      setTimeout(() => loadProductImages(), 100);
    }

    // Initialize page on load
    showTab('middager');

    // Check if we need to auto-search on page load
    const urlParams = new URLSearchParams(window.location.search);
    const autoIngredients = urlParams.get('ingredients');
    const currentTab = urlParams.get('tab');
    
    if (autoIngredients) {
      // Parse ingredients and add as tags
      const ingredientList = autoIngredients.split(',').map(i => i.trim().toLowerCase());
      state.selectedTags.clear();
      ingredientList.forEach(ingredient => {
        if (ingredient) {
          state.selectedTags.add(ingredient);
        }
      });
      updateSelectedTagsDisplay();
      setTimeout(() => searchBestOffers(autoIngredients), 100);
    } else {
      // Always load all meal suggestions when opening the site (regardless of tab)
      setTimeout(() => loadAllMealSuggestions(), 200);
    }
  </script>
</body>
</html>
