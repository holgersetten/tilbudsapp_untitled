<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Middagstilbud (Enkel)</title>
     <style>
          /* --------------------------------------------------
              Design System / Tokens
          -------------------------------------------------- */
        :root {
            /* Lysere, luftigere palett */
            --color-bg: #ffffff;
            --color-bg-alt: #fcfdfe;
            --color-surface: #ffffff;
            --color-surface-alt: #f5f8fb; /* lys chip/card bakgrunn */
            --color-border: #e6edf2; /* litt lysere kant */
            --color-border-strong: #d4dde4;
            --color-text: #1f2732;
            --color-text-soft: #7a8592;
            --color-accent: #1663ff; /* litt klarere bl√• */
            --color-accent-rgb: 22 99 255;
            --color-accent-alt: #0e52d6;
            --color-success: #0c8b4b;
            --color-warm: #ea580c;
            --color-warm-rgb: 234 88 12;
            --radius-xs: 4px;
            --radius-sm: 8px;
            --radius: 10px;
            --radius-lg: 14px;
            --radius-full: 999px;
            --shadow-xs: 0 1px 2px rgba(0 0 0 / 0.03);
            --shadow-sm: 0 2px 4px rgba(0 0 0 / 0.05);
            --shadow: 0 3px 8px rgba(0 0 0 / 0.07);
            --transition: 140ms cubic-bezier(.4,0,.2,1);
            --focus-ring: 0 0 0 3px rgba(var(--color-accent-rgb)/0.3);
        }

          @media (prefers-color-scheme: dark) {
                :root {
                     --color-bg: #0f172a;
                     --color-bg-alt: #0f172a;
                     --color-surface: #1e293b;
                     --color-surface-alt: #162132;
                     --color-border: #334155;
                     --color-border-strong: #475569;
                     --color-text: #f1f5f9;
                     --color-text-soft: #94a3b8;
                     --shadow-xs: 0 1px 2px rgba(0 0 0 / 0.5), 0 0 0 1px rgba(255 255 255 / 0.05);
                     --shadow-sm: 0 2px 4px rgba(0 0 0 / 0.55);
                     --shadow: 0 4px 16px -2px rgba(0 0 0 / 0.6);
                     --shadow-lg: 0 8px 28px -4px rgba(0 0 0 / 0.65);
                }
          }

          /* --------------------------------------------------
              Base / Reset
          -------------------------------------------------- */
          * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: system-ui,-apple-system,"Segoe UI",Roboto,Inter,sans-serif;
            -webkit-font-smoothing: antialiased;
            background:
                linear-gradient(140deg, #ffffff 0%, #f6f9fc 55%, #eef5fb 100%);
            min-height: 100vh;
            color: var(--color-text);
            accent-color: var(--color-accent);
        }
          ::selection { background: rgba(var(--color-accent-rgb)/0.15); }

          a { color: var(--color-accent); text-decoration: none; }
          a:hover { text-decoration: underline; }

          .visually-hidden { position:absolute; inset:-1px; width:1px; height:1px; padding:0; margin:0; overflow:hidden; clip:rect(0 0 0 0); border:0; }

          /* --------------------------------------------------
              Utility
          -------------------------------------------------- */
          .container { max-width: 1240px; margin: 0 auto; padding: 0 24px; }
          .grid-auto { display:grid; gap: var(--gap, 16px); grid-template-columns:repeat(auto-fit,minmax(var(--min,200px),1fr)); }
          .fade-in { animation: fadeIn .4s var(--transition); }
          @keyframes fadeIn { from { opacity:0; transform:translateY(4px);} to { opacity:1; transform:translateY(0);} }

          /* --------------------------------------------------
              Header / Navigation
          -------------------------------------------------- */
          header {
                position: sticky; top: 0; z-index: 40;
                backdrop-filter: saturate(180%) blur(14px);
                background: rgba(255 255 255 / 0.72);
                border-bottom: 1px solid var(--color-border);
          }
          @media (prefers-color-scheme: dark){ header { background: rgba(15 23 42 / 0.72);} }
          .header-content { display:flex; align-items:center; justify-content:space-between; gap:32px; padding:14px 0; }
          .logo { display:flex; align-items:center; gap:12px; }
    .logo-text { font-size: clamp(20px, 2.6vw, 25px); font-weight:700; letter-spacing:-0.02em; color: var(--color-text); background:none; -webkit-background-clip:initial; background-clip:initial; }

          /* Tabs */
          .tabs { display:flex; gap:8px; }
          .tab-btn { background:var(--color-surface); color:var(--color-text-soft); border:1px solid var(--color-border); padding:8px 18px; border-radius: var(--radius-full); font-size:14px; font-weight:500; cursor:pointer; line-height:1; display:inline-flex; gap:6px; align-items:center; transition: var(--transition); }
          .tab-btn:hover { color:var(--color-text); border-color:var(--color-border-strong); }
          .tab-btn.active { background:var(--gradient-accent); color:#fff; border-color:var(--color-accent); box-shadow: var(--shadow-sm); }
          .tab-btn:focus-visible { outline:none; box-shadow: var(--focus-ring); }

          /* --------------------------------------------------
              Hero / Search
          -------------------------------------------------- */
    .hero { text-align:center; padding:56px 0 36px; }
    .hero h2 { margin:0 0 14px; font-size: clamp(30px,4.6vw,44px); line-height:1.1; font-weight:650; letter-spacing:-0.5px; }
    .hero p { margin:0 auto 28px; max-width:560px; color:var(--color-text-soft); font-size:16px; line-height:1.45; }
          .search-box { max-width:720px; margin:0 auto; display:flex; gap:10px; }
          .search-input { position:relative; flex:1; }
    .search-input input { width:100%; padding:14px 18px 14px 50px; border:1px solid var(--color-border); border-radius: var(--radius-full); font-size:15px; background: var(--color-surface); box-shadow:none; transition: var(--transition); }
          .search-input input:hover { border-color: var(--color-border-strong); }
          .search-input input:focus { outline:none; border-color: var(--color-accent); box-shadow: var(--focus-ring); }
          .search-icon { position:absolute; left:18px; top:50%; transform:translateY(-50%); font-size:18px; opacity:.55; }
    .search-btn { padding:14px 24px; border:1px solid var(--color-accent); border-radius: var(--radius-full); font-weight:600; font-size:14px; cursor:pointer; background: var(--color-accent); color:#fff; display:inline-flex; align-items:center; gap:6px; box-shadow:none; transition: var(--transition); }
    .search-btn:hover { filter:brightness(1.05); }
    .search-btn:active { filter:brightness(.95); }
          .search-btn:focus-visible { outline:none; box-shadow: var(--focus-ring); }

          /* --------------------------------------------------
              Store Filter Bar
          -------------------------------------------------- */
    .store-filter { background: rgba(255 255 255 / 0.72); border:1px solid var(--color-border); border-radius: var(--radius-lg); padding:12px 16px; margin:0 0 40px; display:flex; align-items:center; gap:12px; overflow-x:auto; white-space:nowrap; backdrop-filter: blur(8px); scroll-snap-type: x proximity; }
          .store-filter::-webkit-scrollbar { height:6px; }
          .store-filter::-webkit-scrollbar-track { background: transparent; }
          .store-filter::-webkit-scrollbar-thumb { background: var(--color-border); border-radius: 3px; }
          .store-buttons-container { display:flex; gap:14px; flex-wrap:nowrap; min-width:fit-content; }
    .store-btn, .dropdown-btn { position:relative; display:flex; align-items:center; justify-content:center; min-width:86px; height:48px; padding:0 14px; border:1px solid var(--color-border); background:var(--color-surface-alt); border-radius: var(--radius-full); cursor:pointer; gap:8px; font-size:13px; font-weight:500; color:var(--color-text-soft); transition: var(--transition); scroll-snap-align:start; }
    .store-btn:hover, .dropdown-btn:hover { border-color:var(--color-border-strong); background:var(--color-surface); color:var(--color-text); }
    .store-btn.active { background: var(--color-accent); border-color: var(--color-accent); color:#fff; }
          .store-logo-btn { height:34px; max-width:64px; object-fit:contain; filter: drop-shadow(0 1px 1px rgba(0 0 0 / 0.15)); }
          .dropdown-btn { min-width:60px; font-size:20px; }
          .dropdown-content { display:none; position:absolute; right:0; top:60px; min-width:220px; background:var(--color-surface); border:1px solid var(--color-border); border-radius: var(--radius-lg); box-shadow: var(--shadow-lg); padding:8px; backdrop-filter: blur(10px); }
          .dropdown-content.show { display:block; }
          .dropdown-item { display:flex; align-items:center; gap:12px; padding:10px 12px; border-radius: var(--radius-sm); cursor:pointer; transition: var(--transition); font-size:14px; color:var(--color-text); }
          .dropdown-item:hover { background: var(--color-surface-alt); }
          .dropdown-item.active { background: rgba(var(--color-accent-rgb)/0.12); }
          .dropdown-logo { height:26px; width:26px; object-fit:contain; }

          /* --------------------------------------------------
              Meal Suggestions (Forside)
          -------------------------------------------------- */
          .meals-section { margin-bottom:48px; }
          .meals-grid { display:grid; gap:22px; grid-template-columns: repeat(auto-fit,minmax(300px,1fr)); }
    .meal-card { background: var(--color-surface); border:1px solid var(--color-border); border-radius: var(--radius-lg); padding:20px 18px 18px; cursor:pointer; position:relative; transition: var(--transition); display:flex; flex-direction:column; }
    .meal-card:hover { border-color: var(--color-border-strong); box-shadow: 0 2px 6px rgba(0 0 0 / 0.06); background: #ffffff; }
          .meal-header { display:flex; justify-content:space-between; align-items:flex-start; gap:12px; margin:0 0 14px; }
          .meal-title { font-size:19px; margin:0; line-height:1.25; font-weight:600; letter-spacing:-0.01em; }
          .meal-stats { display:flex; flex-direction:column; gap:6px; align-items:flex-end; }
          .difficulty-badge, .offer-badge { padding:4px 10px; border-radius: var(--radius-full); font-size:11px; font-weight:600; letter-spacing:0.3px; line-height:1; }
          .difficulty-badge { background: var(--color-surface-alt); color: var(--color-text-soft); }
          .offer-badge.high-offers { background: #dcfce7; color:#166534; }
          .offer-badge.medium-offers { background: #fef3c7; color:#92400e; }
          .offer-badge.low-offers { background: #fee2e2; color:#991b1b; }
          .meal-ingredients { margin:0 0 14px; }
          .meal-ingredients p { margin:0 0 6px; font-size:13px; font-weight:500; letter-spacing:.2px; color:var(--color-text-soft); }
          .ingredient-list { display:flex; flex-wrap:wrap; gap:6px; }
    .ingredient-tag { font-size:11px; font-weight:500; padding:4px 10px; border-radius: var(--radius-full); background: var(--color-surface-alt); border:1px solid var(--color-border); color: var(--color-text-soft); line-height:1.1; display:inline-flex; gap:4px; align-items:center; }
          .ingredient-tag.has-offer { background:#dcfce7; border-color:#bbf7d0; color:#166534; font-weight:600; }
          .meal-offers-preview { background: var(--color-surface-alt); border:1px solid var(--color-border); padding:12px 14px; border-radius: var(--radius); margin:0 0 14px; }
          .mini-offer { display:flex; justify-content:space-between; font-size:12px; padding:2px 0; }
          .ingredient-name { color: var(--color-text); }
          .store-count { color: var(--color-accent); font-weight:600; }
          .meal-select-btn { width:100%; margin-top: 4px; }

          /* --------------------------------------------------
              Generic Buttons
          -------------------------------------------------- */
          .btn { border:1px solid var(--color-border); background: var(--color-surface-alt); color:var(--color-text); padding:10px 18px; border-radius: var(--radius-full); font-size:14px; font-weight:500; cursor:pointer; display:inline-flex; align-items:center; gap:6px; transition: var(--transition); text-decoration:none; }
          .btn:hover { background: var(--color-surface); border-color: var(--color-border-strong); }
          .btn:focus-visible { outline:none; box-shadow: var(--focus-ring); }
    .btn-primary { background: var(--color-accent); border-color: var(--color-accent); color:#fff; box-shadow:none; }
    .btn-primary:hover { filter:brightness(1.05); }
          .btn-secondary { background: var(--color-surface-alt); }

          /* --------------------------------------------------
              Section / Layout Blocks
          -------------------------------------------------- */
          main { max-width:1240px; margin:0 auto; padding:0 24px 96px; }
          #content { min-height:260px; }
          .section-header { display:flex; justify-content:space-between; align-items:flex-end; flex-wrap:wrap; gap:14px; margin:0 0 22px; }
          .section-title { font-size:26px; font-weight:700; margin:0; letter-spacing:-0.02em; display:flex; gap:10px; align-items:center; }

          /* --------------------------------------------------
              Offers Grid / Cards
          -------------------------------------------------- */
    .offers-grid { display:grid; gap:12px; grid-template-columns: repeat(auto-fit,minmax(200px,1fr)); }
    .offer-card { position:relative; background: var(--color-surface); border:1px solid var(--color-border); border-radius: var(--radius); overflow:hidden; height:178px; display:flex; flex-direction:column; transition: var(--transition); }
    .offer-card:hover { border-color: var(--color-border-strong); box-shadow: 0 2px 6px rgba(0 0 0 / 0.06); background:#ffffff; }
    .offer-image { position:relative; width:100%; height:108px; background: #f5f8fb; display:flex; align-items:center; justify-content:center; overflow:hidden; }
    .offer-product-image { width:100%; height:100%; object-fit:cover; }
    .offer-store-logo { position:absolute; top:6px; left:6px; height:20px; width:auto; background:#ffffff; padding:2px 5px; border-radius: var(--radius-sm); box-shadow: 0 1px 2px rgba(0 0 0 / 0.12); }
          .offer-content { flex:1; padding:8px 9px 8px; display:flex; flex-direction:column; justify-content:space-between; }
    .offer-title { margin:0 0 4px; font-weight:550; font-size:12px; line-height:1.25; height:2.5em; display:-webkit-box; -webkit-line-clamp:2; line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; color:var(--color-text); }
          .offer-price { display:flex; align-items:baseline; gap:4px; margin:0 0 2px; }
    .offer-price-main { font-size:16px; font-weight:650; color: var(--color-accent); letter-spacing:-0.4px; }
          .offer-quantity { font-size:10px; color:var(--color-text-soft); line-height:1.1; white-space:nowrap; }

          /* --------------------------------------------------
              Ingredient Group (Meal Details)
          -------------------------------------------------- */
          .ingredient-section { margin:0 0 40px; }
    .ingredient-header { display:flex; align-items:center; justify-content:space-between; gap:12px; padding:8px 0 14px; border-bottom:1px solid var(--color-border); }
    .ingredient-title { margin:0; font-size:20px; font-weight:600; letter-spacing:-0.5px; color:var(--color-text); }
          .count-badge { background: rgba(var(--color-accent-rgb)/0.12); color: var(--color-accent); font-size:12px; font-weight:600; padding:5px 12px; border-radius: var(--radius-full); }
    .ingredient-group { background: var(--color-surface); border:1px solid var(--color-border); border-radius: var(--radius-lg); padding:18px 18px 22px; box-shadow:none; }
          .ingredient-group h4 { margin:0 0 14px; font-size:18px; font-weight:600; color: var(--color-warm); letter-spacing:-0.5px; }
          .offers-row { display:grid; gap:12px; grid-template-columns: repeat(auto-fit,minmax(200px,1fr)); }
          .more-offers { text-align:center; margin:14px 0 0; font-size:13px; color:var(--color-text-soft); }

          /* --------------------------------------------------
              Meal Detail View
          -------------------------------------------------- */
          .meal-details { max-width:1240px; margin:0 auto; }
          .meal-details .meal-header { border-bottom:1px solid var(--color-border); padding-bottom:16px; margin-bottom:30px; }
          .meal-meta { display:flex; gap:12px; flex-wrap:wrap; margin:12px 0 0; }
          .category-badge { background: rgba(var(--color-warm-rgb)/0.12); color: var(--color-warm); padding:5px 12px; border-radius: var(--radius-full); font-size:12px; font-weight:600; }
          .ingredients-list { margin:0 0 34px; }
          .ingredient-tags { display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
          .ingredients-list .ingredient-tag { font-size:12px; }

          /* --------------------------------------------------
              States / Feedback
          -------------------------------------------------- */
    .loading { position:relative; overflow:hidden; border-radius: var(--radius-lg); background: var(--color-surface); padding:36px 26px; text-align:center; color:var(--color-text-soft); font-size:15px; }
    .loading:before { content:""; position:absolute; inset:0; background: linear-gradient(110deg, transparent 0%, rgba(var(--color-accent-rgb)/0.06) 45%, rgba(var(--color-accent-rgb)/0.10) 55%, transparent 100%); background-size:200% 100%; animation: shimmer 1.5s linear infinite; }
          @keyframes shimmer { to { background-position:-200% 0; } }
    .empty { padding:42px 28px; text-align:center; background: var(--color-surface); border:1px solid var(--color-border); border-radius: var(--radius-lg); color:var(--color-text-soft); }
          .empty h3 { margin-top:0; font-size:20px; }

          /* --------------------------------------------------
              Chips (Optional tag styles)
          -------------------------------------------------- */
          .chips { display:flex; flex-wrap:wrap; gap:8px; margin:18px 0; }
          .chip { background: rgba(var(--color-accent-rgb)/0.12); color: var(--color-accent); font-size:12px; padding:6px 14px; border-radius: var(--radius-full); display:inline-flex; align-items:center; gap:6px; font-weight:500; }
          .chip button { all:unset; cursor:pointer; font-size:16px; line-height:1; padding:0 2px; font-weight:600; }

          /* --------------------------------------------------
              Responsive
          -------------------------------------------------- */
          @media (max-width: 860px) {
                .hero { padding:48px 0 28px; }
                .hero h2 { font-size: clamp(30px,7vw,46px); }
                .search-box { flex-direction:column; }
                .search-btn { width:100%; justify-content:center; }
                .store-filter { margin-bottom:36px; }
                main { padding:0 18px 88px; }
                .meal-card { padding:18px 18px 18px; }
          }
          @media (max-width: 540px) {
                .offer-card { height:176px; }
                .offer-image { height:102px; }
                .offer-price-main { font-size:15px; }
                .meal-title { font-size:17px; }
          }
     </style>
</head>
<body>
    <!-- Sticky Header -->
    <header>
        <div class="header-content">
            <div class="logo">
                <span style="font-size:32px;">üç≥</span>
                <h1 class="logo-text">Middagstilbud</h1>
            </div>
            <nav>
                <div class="tabs">
                    <button class="tab-btn active" data-tab="middager">Middager</button>
                    <button class="tab-btn" data-tab="tilbud">Tilbud</button>
                    <button class="tab-btn" data-tab="handleliste">Handleliste</button>
                </div>
            </nav>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="hero">
        <h2>Hva er det til middag?</h2>
        <p>Vi kobler ukens tilbud til enkle og rimelige middagsforslag.</p>
        <div class="search-box">
            <div class="search-input">
                <span class="search-icon">üîç</span>
                <input type="text" id="ingredientsInput" placeholder="S√∏k etter ingrediens, rett eller butikk‚Ä¶" />
            </div>
            <button class="search-btn" onclick="findOffers()">S√∏k</button>
            <button class="search-btn" onclick="showTestOffers()" style="background: #e3f2fd; color: #1565c0; margin-left: 8px;">üß™ Test</button>
        </div>
    </section>

    <!-- Store Filter -->
    <div class="store-filter">
        <div class="store-buttons-container">
            <!-- Alle butikker -->
            <div class="store-btn active" data-store="" onclick="filterStore(this)" title="Alle butikker">
                <span style="font-size:18px;">üè™</span>
                <span style="font-size:14px; font-weight:600;">Alle butikker</span>
            </div>
            
            <!-- Hovedbutikker (st√∏rste markedsandeler) -->
            <div class="store-btn" data-store="Rema 1000" onclick="filterStore(this)" title="Rema 1000">
                <img src="/images/rema_logo.png" class="store-logo-btn" alt="Rema 1000" />
            </div>
            <div class="store-btn" data-store="Kiwi" onclick="filterStore(this)" title="Kiwi">
                <img src="/images/kiwi_logo.png" class="store-logo-btn" alt="Kiwi" />
            </div>
            <div class="store-btn" data-store="Meny" onclick="filterStore(this)" title="Meny">
                <img src="/images/meny_logo.png" class="store-logo-btn" alt="Meny" />
            </div>
            <div class="store-btn" data-store="Coop Extra" onclick="filterStore(this)" title="Coop Extra">
                <img src="/images/coop_extra_logo.png" class="store-logo-btn" alt="Coop Extra" />
            </div>
            <div class="store-btn" data-store="Bunnpris" onclick="filterStore(this)" title="Bunnpris">
                <img src="/images/bunnpris_logo.png" class="store-logo-btn" alt="Bunnpris" />
            </div>
            
            <!-- Dropdown for mindre butikker -->
            <div class="store-dropdown">
                <div class="dropdown-btn" onclick="toggleDropdown()" title="Flere butikker">
                    <span>‚ãØ</span>
                </div>
                <div class="dropdown-content" id="storeDropdown">
                    <div class="dropdown-item" data-store="Coop Mega" onclick="filterStoreFromDropdown(this)">
                        <img src="/images/coop_mega_logo.png" class="dropdown-logo" alt="Coop Mega" />
                        <span>Coop Mega</span>
                    </div>
                    <div class="dropdown-item" data-store="Coop Marked" onclick="filterStoreFromDropdown(this)">
                        <img src="/images/coop_marked_logo.png" class="dropdown-logo" alt="Coop Marked" />
                        <span>Coop Marked</span>
                    </div>
                    <div class="dropdown-item" data-store="Coop Prix" onclick="filterStoreFromDropdown(this)">
                        <img src="/images/coop_prix_logo.png" class="dropdown-logo" alt="Coop Prix" />
                        <span>Coop Prix</span>
                    </div>
                    <div class="dropdown-item" data-store="Coop Obs" onclick="filterStoreFromDropdown(this)">
                        <img src="/images/coop_obs_logo.png" class="dropdown-logo" alt="Coop Obs" />
                        <span>Coop Obs</span>
                    </div>
                    <div class="dropdown-item" data-store="Spar" onclick="filterStoreFromDropdown(this)">
                        <img src="/images/spar_logo_1.png" class="dropdown-logo" alt="Spar" />
                        <span>Spar</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main>
        <div id="content">
            <!-- Default content will be shown here -->
        </div>
    </main>

    <script>
        // Global state
        const state = {
            offersRaw: [],
            filteredOffers: [],
            currentIngredients: [],
            selectedStore: '',
            loadingOffers: false,
            recipes: []
        };

        // Load product images function
        async function loadProductImages() {
            console.log('üñºÔ∏è Starting loadProductImages function');
            
            const offerCards = document.querySelectorAll('.offer-card[data-store][data-heading]');
            console.log(`üñºÔ∏è Found ${offerCards.length} offer cards with data attributes`);
            
            for (const card of offerCards) {
                const storeName = card.getAttribute('data-store');
                const heading = card.getAttribute('data-heading');
                const imageElement = card.querySelector('.offer-product-image');
                
                console.log(`üñºÔ∏è Processing card: store="${storeName}", heading="${heading}"`);
                
                if (!imageElement) {
                    console.log('üñºÔ∏è No image element found in card');
                    continue;
                }
                
                try {
                    const url = `/api/product-image/${encodeURIComponent(storeName)}/${encodeURIComponent(heading)}`;
                    console.log(`üñºÔ∏è Fetching image from: ${url}`);
                    
                    const response = await fetch(url);
                    if (!response.ok) {
                        console.log(`üñºÔ∏è Failed to fetch image: ${response.status} ${response.statusText}`);
                        continue;
                    }
                    
                    const data = await response.json();
                    console.log(`üñºÔ∏è Received image data:`, data);
                    
                    if (data.imageUrl) {
                        imageElement.src = data.imageUrl;
                        imageElement.style.display = 'block';
                        console.log(`üñºÔ∏è Set image URL: ${data.imageUrl}`);
                    } else {
                        console.log('üñºÔ∏è No imageUrl in response');
                    }
                } catch (error) {
                    console.error(`üñºÔ∏è Error loading image for ${storeName}/${heading}:`, error);
                }
            }
            
            console.log('üñºÔ∏è Finished loadProductImages function');
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            // Set up event listeners
            const input = document.getElementById('ingredientsInput');
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    findOffers();
                }
            });

            // Tab switching
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tab = this.dataset.tab;
                    switchView(tab);
                });
            });

            // Meal details - event delegation for dynamically created buttons
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('meal-select-btn')) {
                    const mealName = e.target.textContent.replace('Se tilbud for ', '');
                    showMealDetails(mealName);
                }
            });

            // Show default content
            showDefaultContent();
        });

        async function findOffers() {
            const input = document.getElementById('ingredientsInput').value.trim();
            if (!input) return;

            console.log('üîç Starting search for:', input);
            state.loadingOffers = true;
            state.currentIngredients = input.split(/[,\s]+/).filter(i => i.length > 0);
            
            try {
                const cleaned = state.currentIngredients.map(i => i.toLowerCase().trim());
                const url = `/api/best-offers?ingredients=${encodeURIComponent(cleaned.join(','))}`;
                console.log('üì° Fetching:', url);
                
                const res = await fetch(url);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                
                state.offersRaw = await res.json();
                console.log('üì¶ Mottok data:', state.offersRaw);
                state.loadingOffers = false;
                renderOffers();
                
                // Last produktbilder etter rendering
                setTimeout(loadProductImages, 100);
            } catch (err) {
                console.error('‚ùå Error:', err);
                state.loadingOffers = false;
                document.getElementById('content').innerHTML = `
                    <div class="empty">
                        <h3>Feil ved s√∏k</h3>
                        <p>Kunne ikke hente tilbud. Pr√∏v igjen senere.</p>
                    </div>
                `;
            }
        }

        function renderOffers() {
            console.log('üé® renderOffers() called');
            console.log('üé® state.offersRaw:', state.offersRaw);
            console.log('üé® state.loadingOffers:', state.loadingOffers);
            
            const content = document.getElementById('content');
            
            if (state.loadingOffers) {
                console.log('üé® Showing loading state');
                content.innerHTML = '<div class="loading">S√∏ker etter tilbud...</div>';
                return;
            }

            if (!state.offersRaw || state.offersRaw.length === 0) {
                console.log('üé® No offers found, showing empty state');
                content.innerHTML = `
                    <div class="empty">
                        <h3>Ingen tilbud funnet</h3>
                        <p>Pr√∏v andre ingredienser eller s√∏keord.</p>
                    </div>
                `;
                return;
            }

            console.log('üé® Processing offers data...');
            // Data comes as grouped format from server: [{ingredient: "name", offers: [...]}]
            const grouped = {};
            state.offersRaw.forEach(group => {
                console.log('üé® Processing group:', group);
                if (group.ingredient && group.offers) {
                    grouped[group.ingredient] = group.offers;
                }
            });
            console.log('üé® Grouped data:', grouped);

            // Apply store filter
            const filteredGrouped = {};
            Object.keys(grouped).forEach(ingredient => {
                filteredGrouped[ingredient] = grouped[ingredient].filter(offer => {
                    if (!state.selectedStore) return true;
                    return offer.store && offer.store.toLowerCase().includes(state.selectedStore.toLowerCase());
                });
            });

            // Render grouped offers
            let html = '<div class="search-results">';
            
            Object.keys(filteredGrouped).forEach(ingredient => {
                const offers = filteredGrouped[ingredient];
                if (offers.length === 0) return;

                html += `
                    <div class="ingredient-section">
                        <div class="ingredient-header">
                            <h3 class="ingredient-title">${ingredient}</h3>
                            <span class="count-badge">${offers.length} tilbud</span>
                        </div>
                        <div class="offers-grid">
                `;

                offers.forEach(offer => {
                    html += `
                        <div class="offer-card" data-store="${offer.store || ''}" data-heading="${offer.title || ''}">
                            <div class="offer-image">
                                <img class="offer-product-image" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100'%3E%3Crect width='100' height='100' fill='%23f3f4f6'/%3E%3Ctext x='50' y='50' text-anchor='middle' dy='.3em' fill='%23999'%3Elaster bilde%3C/text%3E%3C/svg%3E" alt="Produktbilde" style="display:none;" />
                                <img class="offer-store-logo" src="${getStoreLogo(offer.store)}" alt="${offer.store}" />
                            </div>
                            <div class="offer-content">
                                <h4 class="offer-title">${offer.title || 'Ukjent produkt'}</h4>
                                <div class="offer-price">
                                    <span class="offer-price-main">${offer.price || 'N/A'} kr</span>
                                </div>
                                ${offer.quantity ? `<div class="offer-quantity">${offer.quantity}</div>` : ''}
                            </div>
                        </div>
                    `;
                });

                html += '</div></div>';
            });

            html += '</div>';
            console.log('üé® Generated HTML length:', html.length);
            console.log('üé® Setting content.innerHTML...');
            content.innerHTML = html;
            console.log('üé® Content set successfully');
        }

        function getStoreLogo(storeName) {
            const logos = {
                'Rema 1000': '/images/rema_logo.png',
                'Kiwi': '/images/kiwi_logo.png',
                'Meny': '/images/meny_logo.png',
                'Coop Extra': '/images/coop_extra_logo.png',
                'Coop Mega': '/images/coop_mega_logo.png',
                'Coop Marked': '/images/coop_marked_logo.png',
                'Coop Prix': '/images/coop_prix_logo.png',
                'Coop Obs': '/images/coop_obs_logo.png',
                'Bunnpris': '/images/bunnpris_logo.png',
                'Spar': '/images/spar_logo_1.png'
            };
            return logos[storeName] || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="24" height="24"%3E%3Crect width="24" height="24" fill="%23e5e7eb"/%3E%3C/svg%3E';
        }

        function filterStore(btn) {
            // Remove active class from all buttons and dropdown items
            document.querySelectorAll('.store-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.dropdown-item').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            state.selectedStore = btn.dataset.store;
            console.log('üè™ Filter set to:', state.selectedStore || 'Alle butikker');
            renderOffers();
            
            // Close dropdown if open
            document.getElementById('storeDropdown').classList.remove('show');
        }

        function toggleDropdown() {
            const dropdown = document.getElementById('storeDropdown');
            dropdown.classList.toggle('show');
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function closeDropdown(e) {
                if (!e.target.closest('.store-dropdown')) {
                    dropdown.classList.remove('show');
                    document.removeEventListener('click', closeDropdown);
                }
            });
        }

        function filterStoreFromDropdown(item) {
            // Remove active class from all buttons and dropdown items
            document.querySelectorAll('.store-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.dropdown-item').forEach(b => b.classList.remove('active'));
            item.classList.add('active');
            
            state.selectedStore = item.dataset.store;
            console.log('üè™ Filter set to:', state.selectedStore);
            renderOffers();
            
            // Close dropdown
            document.getElementById('storeDropdown').classList.remove('show');
        }

        async function selectMealForOffers(mealName) {
            console.log('üçΩÔ∏è Valgt middag:', mealName);
            
            try {
                // Hent detaljer om middagen
                const response = await fetch(`/api/meals/${encodeURIComponent(mealName)}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const meal = await response.json();
                console.log('üì¶ Hentet middagsdetaljer:', meal);
                
                if (!meal.ingredients || !Array.isArray(meal.ingredients)) {
                    throw new Error('Middag har ingen ingredienser');
                }

                // Sett ingredienser i s√∏kefeltet
                document.getElementById('ingredientsInput').value = meal.ingredients.join(', ');
                
                // Bytt til tilbud-tab
                switchView('tilbud');
                
                // S√∏k etter tilbud for ingrediensene
                await findOffers();
                
            } catch (error) {
                console.error('‚ùå Feil ved valg av middag:', error);
                alert('Kunne ikke hente tilbud for denne middagen. Pr√∏v igjen.');
            }
        }

        function switchView(tab) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tab);
            });

            // Show different content based on tab
            switch(tab) {
                case 'middager':
                    showDefaultContent();
                    break;
                case 'tilbud':
                    if (state.offersRaw.length > 0) {
                        renderOffers();
                        setTimeout(loadProductImages, 100);
                    } else {
                        showDefaultContent();
                    }
                    break;
                case 'handleliste':
                    showShoppingList();
                    break;
            }
        }

        // For testing - simuler noen tilbud med mengdeinformasjon
        function showTestOffers() {
            console.log('üß™ Viser test-tilbud med mengdeinformasjon...');
            const testData = [
                {
                    ingredient: "test produkter",
                    offers: [
                        {
                            title: "COCA-COLA",
                            price: 99,
                            quantity: "6 √ó 1.5l",
                            store: "Bunnpris"
                        },
                        {
                            title: "Mills Majones",
                            price: 25,
                            quantity: "160g",
                            store: "Kiwi"
                        },
                        {
                            title: "Freia Sjokolade",
                            price: 100,
                            quantity: "4 √ó 100g",
                            store: "Rema 1000"
                        },
                        {
                            title: "Stabburet Leverpostei",
                            price: 25,
                            quantity: "6 √ó 22g",
                            store: "Bunnpris"
                        }
                    ]
                }
            ];
            displayResults(testData);
        }

        async function showDefaultContent() {
            console.log('üè† Laster inn forside med middagsforslag...');
            
            try {
                // Vis loading mens vi henter data
                document.getElementById('content').innerHTML = `
                    <div class="loading">
                        <h3>Laster ukens beste middagsforslag...</h3>
                        <p>Finner retter basert p√• tilgjengelige tilbud</p>
                    </div>
                `;

                // Hent rangerte middagsforslag basert p√• tilbud
                const response = await fetch('/api/meals/suggested/by-offers');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const rankedMeals = await response.json();
                console.log('üçΩÔ∏è Mottok rangerte middagsforslag:', rankedMeals.length);

                if (rankedMeals.length === 0) {
                    document.getElementById('content').innerHTML = `
                        <div class="empty">
                            <h3>Ingen middagsforslag tilgjengelig</h3>
                            <p>Pr√∏v √• s√∏ke etter ingredienser i stedet.</p>
                        </div>
                    `;
                    return;
                }

                // Vis topp 6 middagsforslag
                const topMeals = rankedMeals.slice(0, 6);
                let html = `
                    <div class="meals-section">
                        <div class="section-header">
                            <h2 class="section-title">
                                üçΩÔ∏è Ukens beste middagsforslag
                            </h2>
                            <p style="color: var(--muted); font-size: 14px;">
                                Rangert etter tilgjengelige tilbud denne uken
                            </p>
                        </div>
                        <div class="meals-grid">
                `;

                topMeals.forEach(meal => {
                    const difficultyEmoji = {
                        'enkel': 'üü¢',
                        'medium': 'üü°', 
                        'vanskelig': 'üî¥'
                    };

                    html += `
                        <div class="meal-card" onclick="selectMealForOffers('${meal.name}')">
                            <div class="meal-header">
                                <h3 class="meal-title">${meal.name}</h3>
                                <div class="meal-stats">
                                    <span class="difficulty-badge">
                                        ${difficultyEmoji[meal.difficulty] || '‚ö™'} ${meal.difficulty}
                                    </span>
                                    <span class="offer-badge ${meal.offerPercentage >= 50 ? 'high-offers' : meal.offerPercentage >= 25 ? 'medium-offers' : 'low-offers'}">
                                        ${meal.offerPercentage}% p√• tilbud
                                    </span>
                                </div>
                            </div>
                            <div class="meal-ingredients">
                                <p><strong>Ingredienser (${meal.totalIngredients}):</strong></p>
                                <div class="ingredient-list">
                                    ${meal.ingredients.map(ingredient => {
                                        const hasOffer = meal.availableOffers.some(ao => ao.ingredient === ingredient);
                                        return `<span class="ingredient-tag ${hasOffer ? 'has-offer' : ''}">${ingredient}</span>`;
                                    }).join('')}
                                </div>
                            </div>
                            ${meal.offersFound > 0 ? `
                                <div class="meal-offers-preview">
                                    <p><strong>Tilbud funnet (${meal.offersFound}):</strong></p>
                                    ${meal.availableOffers.slice(0, 2).map(ao => 
                                        `<div class="mini-offer">
                                            <span class="ingredient-name">${ao.ingredient}</span>
                                            <span class="store-count">${ao.offers.length} tilbud</span>
                                        </div>`
                                    ).join('')}
                                </div>
                            ` : ''}
                            <button class="btn btn-primary meal-select-btn">
                                Se tilbud for ${meal.name}
                            </button>
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;

                document.getElementById('content').innerHTML = html;
                console.log('‚úÖ Middagsforslag vist p√• forside');

            } catch (error) {
                console.error('‚ùå Feil ved lasting av middagsforslag:', error);
                document.getElementById('content').innerHTML = `
                    <div class="empty">
                        <h3>Feil ved lasting av middagsforslag</h3>
                        <p>Kunne ikke hente forslag. Pr√∏v √• s√∏ke etter ingredienser i stedet.</p>
                    </div>
                `;
            }
        }

        async function showMealDetails(mealName) {
            try {
                console.log(`üçΩÔ∏è Viser detaljer for: ${mealName}`);
                
                // Show loading state
                document.getElementById('content').innerHTML = `
                    <div class="loading-container">
                        <div class="loading">Laster tilbud for ${mealName}...</div>
                    </div>
                `;

                // Get meal details
                const mealResponse = await fetch(`${API_BASE_URL}/meals/${encodeURIComponent(mealName)}`);
                const meal = await mealResponse.json();
                
                if (!meal || !meal.ingredients) {
                    throw new Error('Middagsrett ikke funnet');
                }

                // Get best offers for the meal's ingredients
                const ingredientsQuery = meal.ingredients.join(',');
                const offersResponse = await fetch(`${API_BASE_URL}/best-offers?ingredients=${encodeURIComponent(ingredientsQuery)}`);
                const bestOffers = await offersResponse.json();

                // Display meal details with offers
                let html = `
                    <div class="meal-details">
                        <div class="meal-header">
                            <button class="btn btn-secondary back-btn" onclick="showDefaultContent()">‚Üê Tilbake</button>
                            <h2>${meal.name}</h2>
                            <div class="meal-meta">
                                <span class="difficulty-badge ${meal.difficulty}">${meal.difficulty}</span>
                                <span class="category-badge">${meal.category}</span>
                            </div>
                        </div>
                        
                        <div class="ingredients-list">
                            <h3>Ingredienser (${meal.ingredients.length})</h3>
                            <div class="ingredient-tags">
                                ${meal.ingredients.map(ingredient => 
                                    `<span class="ingredient-tag">${ingredient}</span>`
                                ).join('')}
                            </div>
                        </div>

                        <div class="meal-offers-section">
                            <h3>Beste tilbud for denne retten</h3>
                `;

                if (bestOffers && bestOffers.length > 0) {
                    html += `
                            <div class="offers-grid">
                                ${bestOffers.map(group => `
                                    <div class="ingredient-group">
                                        <h4>${group.ingredient}</h4>
                                        <div class="offers-row">
                                            ${group.offers.slice(0, 3).map(offer => `
                                                <div class="offer-card" data-store="${offer.store || ''}" data-heading="${offer.title || ''}">
                                                    <div class="offer-image">
                                                        <img src="/api/store-logo/${offer.store}" alt="${offer.store}" class="offer-store-logo">
                                                        <div class="product-image-placeholder">üì¶</div>
                                                    </div>
                                                    <div class="offer-content">
                                                        <h4 class="offer-title">${offer.title}</h4>
                                                        <div class="offer-price">
                                                            <span class="offer-price-main">${offer.price} kr</span>
                                                            ${offer.originalPrice ? `<span class="offer-price-original">${offer.originalPrice} kr</span>` : ''}
                                                        </div>
                                                        ${offer.quantity ? `<div class="offer-quantity">${offer.quantity}</div>` : ''}
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                        ${group.offers.length > 3 ? `<p class="more-offers">+ ${group.offers.length - 3} flere tilbud</p>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                    `;
                } else {
                    html += `
                            <div class="empty">
                                <p>Ingen tilbud funnet for ingrediensene i denne retten.</p>
                            </div>
                    `;
                }

                html += `
                        </div>
                    </div>
                `;

                document.getElementById('content').innerHTML = html;
                
                // Load product images for the meal detail view
                setTimeout(() => loadProductImages(), 100);
                
                console.log(`‚úÖ Viser detaljer for ${mealName}`);

            } catch (error) {
                console.error('‚ùå Feil ved lasting av middagsdetaljer:', error);
                document.getElementById('content').innerHTML = `
                    <div class="empty">
                        <h3>Feil ved lasting av middagsrett</h3>
                        <p>Kunne ikke hente detaljer for "${mealName}". <button class="btn btn-secondary" onclick="showDefaultContent()">G√• tilbake</button></p>
                    </div>
                `;
            }
        }

        function showShoppingList() {
            document.getElementById('content').innerHTML = `
                <div class="empty">
                    <h3>Handleliste</h3>
                    <p>Denne funksjonen kommer snart!</p>
                </div>
            `;
        }
    </script>
</body>
</html>
